CREATE PROCEDURE [dbo].[pGetOrderedTestDetailsforChecklist] (@pVisitID     [BIGINT],            
                                               @pBillID      [BIGINT],            
                                               @pOrgID       [BIGINT])            
AS            
  BEGIN  
  DECLARE @Package TABLE   
  (  
   Name NVARCHAR(255)  
  ,DeptName NVARCHAR(255)  
  ,ID INT  
  ,Type NVARCHAR(10)  
  ,PkgName NVARCHAR(255)  
  ,DeptID INT  
  )  
  INSERT INTO @Package (Name, ID, Type, PkgName)  
  SELECT DISTINCT OI.NAME,OI.ID,OI.TYPE, ISNULL(OI.PkgName,'') as PkgName  
  FROM PATIENTVISIT PV (NOLOCK)  
  INNER JOIN ORDEREDINVESTIGATIONS OI (NOLOCK) ON OI.VISITID=PV.PATIENTVISITID AND OI.ORGID=PV.ORGID  
  INNER JOIN FINALBILL FB (NOLOCK) ON FB.VISITID=OI.VISITID AND FB.ORGID=OI.ORGID  
  WHERE ISNULL(OI.PKGNAME,'')='' AND PV.PATIENTVISITID=@pVisitID AND FB.FINALBILLID=@pBillID AND PV.ORGID=@pOrgID  
  
  IF EXISTS (SELECT 1 FROM @Package WHERE TYPE='GRP')  
  BEGIN  
  UPDATE P SET P.DeptName=IDM.DeptName,P.DeptID=IDM.DeptID FROM @Package P  
  INNER JOIN INVORGGROUP IOG ON IOG.ATTGROUPID=P.ID  
  INNER JOIN INVGROUPMAPMASTER IGM ON IGM.GROUPID=IOG.ORGGROUPID AND IGM.ACTIVE='Y'  
  INNER JOIN INVESTIGATIONORGMAPPING IOM ON IOM.INVESTIGATIONID=IGM.INVESTIGATIONID AND IOM.ORGID=IOG.ORGID  
  INNER JOIN INVDEPTMASTER IDM ON IDM.DEPTID=IOM.DEPTID AND IDM.ORGID=IOM.ORGID  
  WHERE IOG.ORGID=@pOrgID AND P.TYPE='GRP'  
  END  
  
  IF EXISTS (SELECT 1 FROM @Package WHERE TYPE='INV')  
  BEGIN  
  UPDATE P SET P.DeptName=IDM.DeptName,P.DeptID=IDM.DeptID FROM @Package P  
  INNER JOIN INVESTIGATIONORGMAPPING IOM ON IOM.INVESTIGATIONID=P.ID AND IOM.ORGID=@pOrgID  
  INNER JOIN INVDEPTMASTER IDM ON IDM.DEPTID=IOM.DEPTID AND IDM.ORGID=IOM.ORGID  
  WHERE IOM.ORGID=@pOrgID AND P.TYPE='INV'  
  END  
  
  Declare @Final Table   
  (  
  SLno INT IDENTITY(1,1),  
  Name NVARCHAR(255)  
  ,DeptName NVARCHAR(255)  
  ,DeptID INT  
  ,PkgName NVARCHAR(255)  
  ,CheckBox Bit  
  )  
  Insert into @Final (Name, DeptName, DeptID, PkgName, CheckBox)  
  SELECT DISTINCT Name, DeptName, DeptID, PkgName, 0 as CheckBox FROM @Package ORDER BY DeptID  
  
  SELECT SLno, Name, ISNULL(DeptName,'') AS DeptName, ISNULL(PkgName,'') as PkgName,CheckBox FROM @Final ORDER BY SLno  
  END  