CREATE PROCEDURE [dbo].[PgetinvestigationvaluesreportwithheaderidQM]    
(@pVisitID   BIGINT,                                                                                                                          
 @OrgID      INT,                                                                                                                          
 @TemplateID INT,                                                                                                                          
@InvestigationID VARCHAR(max)                                                                                                
)                                                                                                                          
--With recompile                                                                        
AS                                                                                                          
                                                                                       
BEGIN                     
SET NOCOUNT ON;                                                                                                         
DECLARE @tblInvestigationValues TABLE                                                                                                                          
(                                                                                                                          
[investigationvalueid]          [BIGINT],                                                                                                                          
[name]                          [VARCHAR](max) NULL,                                                                                                                          
[value]                         [NVARCHAR](max) NULL,                                                                                                                          
[investigationid]               [BIGINT] NULL,                                                                                                                          
[groupid]                       [INT] NULL,                                                                                                                          
[patientvisitid]                [BIGINT] NULL,                                                                                                                          
[uomid]                         [INT] NULL,                                                                                                                          
[status]                        [VARCHAR](100) NULL,                                                                                                                          
[createdby]                     [BIGINT] NULL,                                                                                                                          
[createdat]                     [DATETIME] NULL,                                                                                                                          
[modifiedby]                    [BIGINT] NULL,                                                                                                                          
[modifiedat]                    [DATETIME] NULL,                                                                                                                          
[uomcode]                       [VARCHAR](50) NULL,                                                                                                                          
[groupname]                     [VARCHAR](max) NULL,                                                                                                                          
[orgid]                         [INT] NULL,                                                       
[ipinvsamplecollectionmasterid] [BIGINT] NULL,                     
[packageid]      [INT] NULL,                        
[packagename]  [VARCHAR](max),                                                                                                                          
[sequenceno]                    [INT],                                                                                                 
[uid]                           [VARCHAR](255),                                        
[newvalue]                      [NVARCHAR](20) NULL,                                                          
[convvalue]                     [NVARCHAR](max) NULL,                                                                             
[ConvUOMCode]    [varchar](50) null,                                                                        
[OtherLanguage] [NVarchar](200)NULL,                                                                        
[OtherLanguageHeader][NVARCHAR](200)NULL                                                                        
)                                                                                                             
DECLARE @tblPatientInvestigation TABLE                                                                           
(                                                                          
[patientvisitid]                 [BIGINT],                                                                                                              
[investigationid]           [BIGINT],                                                            
[investigationname]              [VARCHAR](max),                                                                                            
[createdby]                      [BIGINT],                                                                                                                  
[createdat] [DATETIME],                                                                                                                          
[modifiedby]                 [BIGINT],                                                                                                                          
[modifiedat]                     [DATETIME],                                                                                   
[investigationmethodid]          [BIGINT],                                                                                         
[investigationsamplecontainerid] [INT],                                                                                        
[sampleid]                       [INT],                                                                                                                          
[investigationsiteid]            [INT],                                                                                                        
[iscompleted]                    [CHAR](1),                                                                                                       
[collecteddatetime]              [DATETIME],                                                                                                   
[status]                         [VARCHAR](100),                                                                                               
[complaintid]                    [INT],                                                                                                                          
[groupid]                        [INT],                                                                                                                          
[groupname]        [VARCHAR](max),                                                                                             
[reason]                         [VARCHAR](max),                                                                                                  
[reportstatus]                   [VARCHAR](500),          
[referencerange]   [VARCHAR](max),                                           
           [PrintableRange]             [VARCHAR](max),        
[methodname]                     [VARCHAR](max),              
[ipinvsamplecollectionmasterid]  [BIGINT],                                          
[orgid]             [INT],                                  
[worklistdeletedstatus]          [VARCHAR](50),                                                                                                                          
[performingphysicainname]        [VARCHAR](500),                                 
[kitid]                          [BIGINT],                           
[kitname]                        [VARCHAR](255),                                         
[instrumentid]            [BIGINT],                                                                                                                        
[instrumentname]                 [VARCHAR](max),                                                      
[interpretation]                 [VARCHAR](max),                                                      
[principleid]                    [BIGINT],                                            
[principlename]                  [VARCHAR](max),                                                                                                                          
[qcdata]                         [VARCHAR](max),                                                                                                                          
[packageid]             [INT],                                                                                                                          
[packagename]                    [VARCHAR](max),                                                                                                                          
[approvedby]    [BIGINT],                                                                                           
[patientinvid]                   [BIGINT],                                                                                                          
[orderedat]                      [DATETIME],                                                                                                                        
[uid]  [VARCHAR](255),                                                                        
[groupcomment]                   [VARCHAR](max),                                                                                                                          
[approvedat]                    [DATETIME],                                                                                                                          
[accessionnumber]                [BIGINT],                                                                                                                          
[isabnormal]          [VARCHAR](80),                                                                                                                          
[medicalremarks]                 [NVARCHAR](max),                                                                                                       
[GroupMedicalRemarks]            [VARCHAR](255),                                                                            
refsuffixtext                    VARCHAR(max),                                                                                                                          
[isnonreportable]             [CHAR] (1),                                                                                                                       
[authorizedby]                   [BIGINT],                                                                                                                          
[convreferencerange]             [NVARCHAR](max)                                                            
)          
DECLARE @tblRecheckTestDetails TABLE                                                                
(              
[patientvisitid] [BIGINT],                                                                            
[investigationid]   [BIGINT],                                                                
[investigationname] [VARCHAR](max),                                                     
oldaccessionnumber  BIGINT,                                                                                       
[olduid]    [VARCHAR](255),                                                                                                                       
[orgid]             [INT],                                                                                                                          
newaccessionnumber  BIGINT,                             
[newuid]            [VARCHAR](255),                                           
groupid             INT,                                                                                         
packageid       INT,                                                                                                                          
[oldvalues]       [NVARCHAR](max) NULL,                                                                                                                          
[newvalue]          [NVARCHAR](max) NULL,                                                                               
[oldconvvalues]     [NVARCHAR](max) NULL,                                                                                                                          
[newconvvalue]      [NVARCHAR](max) NULL                                                                                                                          
)                                                                               
DECLARE @tblRetestDetails TABLE                                                                                                                          
(                                                                                              
[patientvisitid]    [BIGINT],                                                                                                                          
[investigationid]   [BIGINT],                                                  
[investigationname] [VARCHAR](max),                                                                                                                     
oldaccessionnumber  BIGINT,                                                            
[olduid]            [VARCHAR](255),                                                                                                            
[orgid]             [INT],                                                                      
newaccessionnumber  BIGINT,                                                                                                                          
[newuid]            [VARCHAR](255),                                                                                                                       
groupid             INT,                                                                                                                          
packageid       INT,                                                                                                                          
[oldvalues]         [NVARCHAR](max) NULL,                                                                        
[newvalue]          [NVARCHAR](max) NULL,                                                                                                                          
[oldconvvalues]  [NVARCHAR](max) NULL,                                                           
[newconvvalue]      [NVARCHAR](max) NULL                      
)                                          DECLARE @tblOrdPerfOrgGrpInvDtls TABLE      
(                                                                      
orderedorgid        INT,                              
performedorgid      INT,                                  
attunegroupid       INT,                                                                                   
invtype             VARCHAR(10),                                                      
performedorggroupid INT,                                                    
performedorguid     VARCHAR(max),                                            
orderedorggroupid   INT,                                                                                                                          
orderedorguid       VARCHAR(max)                                                                   
)                            
DECLARE @tblAffectedVisits TABLE                                                                         
(                                                            
visitid BIGINT,                                                                                  
orgid   BIGINT                                                        
)                                                                                                                          
DECLARE @OrderedPatientInv TABLE                                                                              
(                                                                                                                          
[patientvisitid]                 [BIGINT],                                                                      
[investigationid]              [BIGINT],                                                  
[investigationname]              [VARCHAR](250),                                                                                                                          
[investigationmethodid]          [BIGINT],                                                                                   
[investigationsamplecontainerid] [INT],                                         
[sampleid]                       [INT],                                                                                                                          
[groupid]                        BIGINT,                                                                                                                          
[groupname]                      [VARCHAR](250),                                                                                                                     
[reason]                         [VARCHAR](250),                                                                                                                          
[referencerange]                 [VARCHAR](max),                                                                                                                          
           [PrintableRange]                 [VARCHAR](max),        
[methodname]                     [VARCHAR](255),                                                                     
[orgid]                          [INT],                                                                                                                          
[worklistdeletedstatus]          [VARCHAR](50),                                                                           
[performingphysicainname]        [VARCHAR](500),                                                                                                                          
[kitid]                          [BIGINT],                                                                             
[kitname]                        [VARCHAR](255),                                                              
[instrumentid]                   [BIGINT],               
[instrumentname]            [VARCHAR](255),           
[interpretation]                 [VARCHAR](max),                            
[principleid] [BIGINT],                
[principlename]                  [VARCHAR](255),                  
[qcdata]        [VARCHAR](max),                                                                                                                          
[packageid]                      [INT],                                                                                                                   
[packagename]                    [VARCHAR](255),                                                                                                   
[approvedby]                     [BIGINT],                                                                                                                          
[patientinvid]                   [BIGINT],                                                                                                                          
[uid]               [VARCHAR](255),                                                                                                                          
[groupcomment]                   [VARCHAR](255),                                                                                                                   
[approvedat]       [DATETIME],                                                                                                                          
[accessionnumber]                [BIGINT],                                                                                                                          
refrangesuffixtest      VARCHAR(max),                                                                                          
[authorizedby]                   [BIGINT],                                                                                
convreferencerange               [NVARCHAR](max)                                                                                                       
)                                                                                                                          
DECLARE @tblResultSelectID TABLE                                                                     
(                                                                                                                      
accessionno BIGINT                                                                                                                      
)                                                                                                                          
                                                                                                                          
INSERT INTO @tblResultSelectID                                                                                     
(accessionno)                                                     
SELECT DISTINCT item                                                                                                                          
FROM   Fnsplit(@InvestigationID, ',')                                                                                                                          
                                                                                                                   
INSERT INTO @OrderedPatientInv                                                                                                           
SELECT [patientvisitid],                                                                                                                          
investigationid,            
[investigationname],        
[investigationmethodid],     
[investigationsamplecontainerid],                                  
[sampleid],                                                           
[groupid],                                    
[groupname],    
[reason],                                                                                        
[referencerange],                                                                                                              
             [PrintableRange],        
[methodname],                                                        
orgid,                                                                                                                          
[worklistdeletedstatus],                                                                
[performingphysicainname],                                                                                                                 
[kitid],                                        
[kitname],                                                                                                                          
[instrumentid],                                                                
[instrumentname],                                                                                          
[interpretation],                                                                                                                          
[principleid],                                                                                                                          
[principlename],                                                                                                                      
[qcdata],                                         
[packageid],                                                                                                                          
[packagename],                                                                   
[approvedby],                                                                                       
[patientinvid],                                                                
uid,                                             
[groupcomment],                                                                                                                          
[approvedat],                                                                                                                          
accessionnumber,                                                                                     
groupmedicalremarks,                                                                                                        
authorizedby,                                                                                                                          
convreferencerange                                                                                                                
FROM   patientinvestigation  WITH (NOLOCK)                                                                                                                         
WHERE  accessionnumber IN (SELECT accessionnumber FROM   orderedinvestigations OI WITH (NOLOCK) 
  
    
    
    
      
      
      
      
        
          
            
INNER JOIN @tblResultSelectID tbl                                                                                   
ON tbl.accessionno =                                                                           
OI.referredaccessionno)                                                               
                                                     
                                                
                                
DECLARE @tblResultSelectUID TABLE         
(                                          
uid VARCHAR(255)                   
)                                                         
                                                                   
INSERT INTO @tblResultSelectUID                                                                                   
(uid)                              
SELECT DISTINCT OI.uid                                                                 
FROM   orderedinvestigations OI WITH(nolock)                                               
INNER JOIN @tblResultSelectID trs                                                                                                       
ON OI.accessionnumber = trs.accessionno                                                                    
WHERE  OI.visitid = @pVisitID                                                                                                                          
AND OI.orgid = @OrgID                                                                                                                          
                            
INSERT INTO @tblAffectedVisits                                                                                                            
SELECT @pVisitID,                                       
@OrgID                                                                                                                          
UNION                                                                                              
SELECT patientvisitid,                                                                                                                          
ORgID                                                                                                         
FROM   patientvisit WITH (NOLOCK)                                                                                      
WHERE  refervisitid = @pVisitID                                                     
                                  INSERT INTO @tblInvestigationValues                                                                                                                    
SELECT [investigationvalueid],                                                                                                                          
[name] + ' ' + ( CASE                                                                                              
WHEN IOA.isnabl = 'Y' THEN '<b>*</b>'                                                                                                                          
ELSE ''                                                                                          
END ) + ' ' + ( CASE                                                                                                                          
WHEN IOA.iscap = 'Y' THEN '<b>#</b>'                                                                              
ELSE ''                                                            
END ) AS [Name],                                                                                                                          
[value],                                                                                                                          
INV1.[investigationid]                 AS [InvestigationID],                                         
[groupid],                                                                                                                          
[patientvisitid],                                                                                                                          
[uomid],                                                 
[status],                                                                                              
[createdby],                  
[createdat],                                                                  [modifiedby],         
[modifiedat],                                                                     
[uomcode],                         
[groupname],                     
INV1.[orgid],                                                                                  
[ipinvsamplecollectionmasterid],                                  
[packageid],                                                                          
[packagename],                                                                                                 
[sequenceno],                                                                                             
[uid],                                                                                                            
'',                                                        
[convvalue],                                                                          
ConvUOMCode,                                                                        
'',                                                                        
''                                                                        
FROM   investigationvalues INV1 WITH (NOLOCK)                                                                                    
INNER JOIN @tblAffectedVisits v2                                                                                                                          
ON INV1.patientvisitid = v2.visitid                                                                                                                          
INNER JOIN invreportmapping IRM WITH (NOLOCK)                                                                                                                          
ON IRM.investigationid = INV1.investigationid                                                                                                          
AND IRM.templateid = @TemplateID                                                                                                                          
LEFT JOIN investigationorgattributes IOA WITH (NOLOCK)                                                                                                                          
ON INV1.orgid = IOA.orgid                                                                                                                  
AND INV1.investigationid = IOA.investigationid                                                                                      
WHERE isnull(INV1.statustype,'') <> 'RC'                                                                                                                        
                                        
/*Recheck Investigations Order Merging with Parent Group Order Start*/                                                                                                                      
INSERT INTO @tblRecheckTestDetails                               
([patientvisitid],                                                                                                                          
[investigationid],                                                            
[investigationname],                                                                                                                          
oldaccessionnumber,                                                                         
[olduid],                                                                                      
[orgid],                                                                                                                          
groupid,            
packageid)                                                        
SELECT PINV.[patientvisitid],                         
[PINV].investigationid,                                                                                                                          
[investigationname],                                                                           
PINV.[accessionnumber],                                         
PINV.[uid],                                             
PINV.[orgid],                         
PINV.groupid,                                                                                                       
PINV.packageid                                                                                                                          
FROM   patientinvestigation PINV WITH (NOLOCK)                                                                                                            
INNER JOIN @tblResultSelectID tbl                                                                                                                          
ON tbl.accessionno = PINV.accessionnumber                                                                                           
WHERE  PINV.status = 'Recheck'                                                                                                                          
                                                                                                                          
UPDATE t1                                                                                                                          
SET    t1.newaccessionnumber = tmp.accessionnumber                                                                                                                          
FROM   @tblRecheckTestDetails t1                                                                                                               
INNER JOIN (SELECT investigationid,                                                                                                             
Max(OI.accessionnumber) AS AccessionNumber                                                                                                                          
FROM   orderedinvestigations OI                                                                                                                   
INNER JOIN @tblRecheckTestDetails t                                                                               
ON t.patientvisitid = OI.visitid                                                                                                                   
AND t.investigationid = OI.id                                                                                                                          
AND t.orgid = OI.orgid                                                                                                                          
WHERE  referredtype = 'Recheck'                                                                      
GROUP  BY t.investigationid) AS tmp                                                                                                                          
ON tmp.investigationid = t1.investigationid                                                                                                                         
                                   
UPDATE t1                                                                                                                          
SET    t1.newuid = OI.uid                                                                          
FROM   @tblRecheckTestDetails t1                                                                                                         
INNER JOIN orderedinvestigations OI                                 
ON OI.accessionnumber = t1.newaccessionnumber      
AND OI.orgid = t1.orgid                                                                                                      
                                                                            
UPDATE t                                                        
SET    t.oldvalues = IV.value,                                                                  
t.oldconvvalues = IV.convvalue             
FROM  @tblRecheckTestDetails T                                                                                            
INNER JOIN investigationvalues IV                                                                 
ON T.patientvisitid = IV.patientvisitid                                                                                                                          
AND T.investigationid = IV.investigationid                                                                               
AND T.groupid = IV.groupid                                                                                                         
AND T.packageid = IV.packageid                                                                                                                          
AND T.orgid = IV.orgid                                                       
AND T.olduid = IV.uid                                                                                                                          
                                                                      
UPDATE t                                                                                                                          
SET t.newvalue = IV.value,                                                                      t.newconvvalue = IV.convvalue                                                                           
FROM   @tblRecheckTestDetails T                                                                                                                        
INNER JOIN investigationvalues IV                                                                                                                          
ON T.patientvisitid = IV.patientvisitid                                                                                                                          
AND T.investigationid = IV.investigationid                                                                                                                          
AND T.orgid = IV.orgid                                                                                                       
AND T.newuid = IV.uid                                                                            
                                                                                                                          
UPDATE iv                                                                                                                          
SET    iv.value = T.newvalue,                                                                                                                          
iv.newvalue = ' (RC)',                                                                                                                          
iv.convvalue = T.newconvvalue                                                     
FROM   @tblInvestigationValues IV                               
INNER JOIN @tblRecheckTestDetails T         
ON T.patientvisitid = IV.patientvisitid                                                                                                                          
AND T.investigationid = IV.investigationid                                                                                                                
AND T.olduid = IV.uid                             
                                               
--Delete @tblInvestigationValues where Value is Null--if Investigation Value is Null,it will not disploy in Report                                                                                                                                            




  
    
    
    
      
      
      
      
        
          
            
              
                
                  
                    
              
                        
                           
                   
   
                                
                                  
                                    
                                      
--Select * from @tblRecheckTestDetails                                                                                                                  
--select * from @tblInvestigationValues                                                      
/*Recheck Investigations Order Merging with Parent Group Order Start*/                                                                                                                      
/*Retest Investigations Order Merging with Parent Group Order Start*/                              
INSERT INTO @tblRetestDetails                                    
([patientvisitid],                                                                                                                          
[investigationid],                                                                                                                          
[investigationname],                              
oldaccessionnumber,                                                                                                                          
[olduid],                                                    
[orgid],                                                                                                                          
groupid,                                                                                                 
packageid)                                                                                                       
SELECT PINV.[patientvisitid],                                                                        
[PINV].investigationid,                                                                                                                          
[investigationname],                                                    
PINV.[accessionnumber],                                                                      
PINV.[uid],                                                                                                                          
PINV.[orgid],                                                                                                                          
PINV.groupid,                                                                            
PINV.packageid                                                                                                                          
FROM patientinvestigation PINV WITH (NOLOCK)                                                                                                                       
INNER JOIN @tblResultSelectID tbl                                                                                                                          
ON tbl.accessionno = PINV.accessionnumber                                                                                                                     
WHERE  PINV.statustype='RR'              
                                                            
--select * from   @tblRetestDetails                                                                 
                                                            
UPDATE t1                                                                                                                          
SET    t1.newaccessionnumber = tmp.accessionnumber                                                                           
FROM   @tblRetestDetails t1                                                        
INNER JOIN (SELECT investigationid,                                                                                
Max(OI.accessionnumber) AS AccessionNumber                                                                              
FROM   orderedinvestigations OI      
INNER JOIN @tblRetestDetails t                                                     
ON t.patientvisitid = OI.visitid                            
AND t.investigationid = OI.id                      
AND t.orgid = OI.orgid                                                                                
WHERE  referredtype = 'Retest'              
GROUP  BY t.investigationid) AS tmp                                                                                                                 
ON tmp.investigationid = t1.investigationid                                                                                                                          
                                                                                                                        
UPDATE t1                                                             
SET    t1.newuid = OI.uid                                                                                                     
FROM   @tblRetestDetails t1                                                                                                                          
INNER JOIN orderedinvestigations OI                                                                                                                          
ON OI.accessionnumber = t1.newaccessionnumber                                                                                                                          
AND OI.orgid = t1.orgid                                                                          
                                                                                                          
UPDATE t                                                                                    
SET    t.oldvalues = IV.value,                                                                                                 
t.oldconvvalues = IV.convvalue                                                              
FROM   @tblRetestDetails T                                                                                                                          
INNER JOIN investigationvalues IV                                                                                                                  
ON T.patientvisitid = IV.patientvisitid                                                              
AND T.investigationid = IV.investigationid                                                                                                                          
AND T.groupid = IV.groupid                                                                                            
AND T.packageid = IV.packageid                                                                                                                          
AND T.orgid = IV.orgid                                                                                 
AND T.olduid = IV.uid                                                                                                            
                                                                                                       
UPDATE t                                                                                    
SET    t.newvalue = IV.value,                                                                                                                          
t.newconvvalue = IV.convvalue                              
FROM   @tblRetestDetails T                                   
INNER JOIN investigationvalues IV                                                               
ON T.patientvisitid = IV.patientvisitid                                                                                          
AND T.investigationid = IV.investigationid                                                                         
AND T.orgid = IV.orgid                
AND T.newuid = IV.uid                      
                                            
UPDATE iv       
SET    iv.value = T.newvalue,                                                                                                                          
iv.newvalue = ' (RT)',                                                                                                                          
iv.convvalue = T.newconvvalue                                           
FROM   @tblInvestigationValues IV                                                                                                                          
INNER JOIN @tblRetestDetails T                                                                                                                          
ON T.patientvisitid = IV.patientvisitid                                                                                                                          
AND T.investigationid = IV.investigationid                                                                                                                          
AND T.olduid = IV.uid                                     
                                                                                                        
--Delete @tblInvestigationValues where Value is Null--if Investigation Value is Null,it will not disploy in Report                                                                           
--Select * from @tblRecheckTestDetails                                                                                                                                                                               
--select * from @tblInvestigationValues                                                  
--return                                                                                   
/*Retest Investigations Order Merging with Parent Group Order Start*/                                                                                                       
INSERT INTO @tblPatientInvestigation                                                                                                             
SELECT [patientvisitid],                                                                                                                          
[PINV].investigationid,                                               
[investigationname],                                                                                                                
PINV.[createdby],                                                              
PINV.[createdat],                                                    
PINV.[modifiedby],                                                                                                                          
PINV.[modifiedat],                                                                  
[investigationmethodid],                                                                                                
[investigationsamplecontainerid],                                                      
[sampleid],                                                                                                                          
[investigationsiteid],                                                                                                                          
[iscompleted],          
[collecteddatetime],                                                                         
[status],                               
[complaintid],                                                                                                                          
[groupid],                                                                                                                 
[groupname],                                                                                                         
[reason],                               
[reportstatus],                                                                                                                   
PINV.[referencerange],               
              PINV.PrintableRange,        
[methodname],               
[ipinvsamplecollectionmasterid],                                                              
PINV.[orgid],                                                                    
[worklistdeletedstatus],                                            
[performingphysicainname],                                                                                                                          
PINV.[kitid],                                                                                                                          
[kitname],                                                                
PINV.[instrumentid],                                                                                 
[instrumentname],                                                                                                                          
PINV.[interpretation],                                                                                                  
PINV.[principleid],                                                                                                                          
[principlename],                                                              
PINV.[qcdata],                                                                                                                          
[packageid],                                                                                  
[packagename],                                                                                                                          
[approvedby],                                                                                                                          
[patientinvid],                                                                                                                          
[orderedat],                                                                             
[uid],                                                                                                            
[groupcomment],                                                                                                                        
[approvedat],                                                                                                               
PINV.[accessionnumber],                                                                                                                          
PINV.isabnormal,                                               
PINV.medicalremarks,                                                                                       
PINV.groupmedicalremarks,                                                                   
PINV.refsuffixtext,                                                                                                                          
IOM.isnonreportable,                                                                                                                         
PINV.authorizedby,                                                                       
PINV.convreferencerange                                                                                                         
FROM   patientinvestigation PINV WITH (NOLOCK)                                                                                
INNER JOIN @tblResultSelectID tbl                                                                                    
ON tbl.accessionno = PINV.accessionnumber                                                                    
INNER JOIN investigationorgmapping IOM  WITH (NOLOCK)                                        
ON IOM.investigationid = PINV.investigationid                          
AND IOM.orgid = PINV.orgid                                                                                                                          
AND PINV.status IN ( 'Pending', 'Completed', 'Approve',                                                                
'Validate',                                                                                              
'Recheck', 'ReflexTest', 'Reject',                                                                      
'Retest',                                                                                                                      
'Co-authorize')                                                                                                                          
INNER JOIN invreportmapping IRM                                                                                                   
ON IRM.investigationid = PINV.investigationid                         
AND IRM.templateid = @TemplateID                                                                                                                          
                                                            
--select * from @tblPatientInvestigation                                                                                      
UPDATE @tblPatientInvestigation                                         
SET    referencerange = ORDBTL.referencerange,                                                                                                                          
             PrintableRange = ordbtl.PrintableRange,             
methodname = ORDBTL.methodname,                                                                                             
reason = ORDBTL.reason,                                                                                                                          
interpretation = ORDBTL.interpretation,                                                                                                                          
kitname = ORDBTL.kitname,                                                                                                                          
convreferencerange = ORDBTL.convreferencerange                                                            
FROM   @tblPatientInvestigation TBL1                                                                                                                          
INNER JOIN @OrderedPatientInv ORDBTL                                                                                                                     
ON ORDBTL.investigationid = TBL1.investigationid 
                    
                  INSERT INTO @tblOrdPerfOrgGrpInvDtls                                                                                                                          
(orderedorgid,                                                              
performedorgid,                                                                              
attunegroupid,                                                                                               
invtype,                                                                                                                          
performedorggroupid)                                             
SELECT @OrgID,      
OA.ORgID,                             
OI.id,                                                                                                                          
OI.type,                                                                                       
CASE                                                                                                                          
WHEN OI.type = 'GRP' THEN IOG.orggroupid                                      
ELSE OI.id                                     
END                                                                           
FROM   orderedinvestigations OI WITH(nolock)                                   
INNER JOIN organizationaddress OA WITH(nolock)                                                                                               
ON OI.rescaptureloc = OA.addressid                                                                   
LEFT JOIN invorggroup IOG WITH(nolock)                                                   
ON IOG.attgroupid = OI.id                                                                                              
AND IOG.orgid = OA.ORgID                                                                                                                  
WHERE  OI.visitid = @pVisitID                                                                                                                          
                                                                             
UPDATE t                                                                                                                          
SET    t.orderedorggroupid = IOG.orggroupid                                                                                                                          
FROM   @tblOrdPerfOrgGrpInvDtls T                                                                                                  
INNER JOIN invorggroup IOG                                                                                                                          
ON T.attunegroupid = IOG.attgroupid                                                                                                                        
AND IOG.orgid = @OrgID                                                                                                                          
WHERE  t.invtype != 'INV'                                                                                                                       
                                                                          
UPDATE t                                                                                                                          
SET    t.performedorguid = OI.uid                                                                                                                          
FROM   @tblOrdPerfOrgGrpInvDtls T                                                                                                                          
INNER JOIN orderedinvestigations OI                                                                                                                          
ON T.performedorgid = OI.orgid                                                                                                                        
AND T.attunegroupid = OI.id                                                                                                                          
AND t.invtype = OI.type                                                                                                         
INNER JOIN @tblResultSelectID TRS                                         
ON TRS.accessionno = OI.referredaccessionno                                                                       
INNER JOIN @tblAffectedVisits TAV                                                                         
ON TAV.visitid = OI.visitid                                                                                                                          
AND TAV.orgid = T.performedorgid                                                                                                                          
                                                           
UPDATE t                        
SET    t.performedorguid = OI.uid                                        
FROM   @tblOrdPerfOrgGrpInvDtls T                                                                 
INNER JOIN orderedinvestigations OI                     
ON T.performedorgid = OI.orgid                          AND T.attunegroupid = OI.id                                                                                                                          
AND t.invtype = OI.type                                                                                                                       
INNER JOIN @tblResultSelectID TRS                                                                                                                     
ON TRS.accessionno = OI.referredaccessionno                                                                              
INNER JOIN @tblAffectedVisits TAV                                                                                                                          
ON TAV.visitid = OI.visitid                                                                       
AND TAV.orgid = T.performedorgid                                                                                                                          
                                                                                                                          
UPDATE t                                                                             
SET    t.orderedorguid = OI.uid                                                                                                                         
FROM   @tblOrdPerfOrgGrpInvDtls T                                                                                                                          
INNER JOIN orderedinvestigations OI                                                                                                                           
ON T.orderedorgid = OI.orgid                                                                                                                          
AND T.attunegroupid = OI.id                                                          
AND OI.visitid = @pVisitID                                          INNER JOIN @tblAffectedVisits TAV                                                               
ON TAV.visitid = OI.visitid                                                                                                                          
AND TAV.orgid = T.orderedorgid                                                      
                                                                                                                          
UPDATE @tblOrdPerfOrgGrpInvDtls                                                                                      
SET    performedorguid = orderedorguid                                                                                               
WHERE  orderedorgid = performedorgid                                             
                                                                                                                          
IF( 1 < (SELECT Count(1)           
FROM   @tblAffectedVisits) )                                                                                                                          
BEGIN                                                                                     
UPDATE t                                                               
SET    patientvisitid = @pVisitID,                                                                                                                       
orgid = @OrgID,                                                                               
groupid = T1.orderedorggroupid,                 
uid = T1.orderedorguid                                                                                                                     
FROM   @tblInvestigationValues T                                                                         
INNER JOIN @tblOrdPerfOrgGrpInvDtls T1                
ON T.uid = T1.performedorguid                                
AND T.groupid = T1.performedorggroupid                              
WHERE  T1.invtype != 'INV'                                                                                                                          
                                                  
UPDATE t                                                                                                                          
SET    patientvisitid = @pVisitID,                                                                                       
orgid = @OrgID,                                                                   
uid = T1.orderedorguid                                       
FROM   @tblInvestigationValues T                                                                                                                          
INNER JOIN @tblOrdPerfOrgGrpInvDtls T1                                                                                                                          
ON T.uid = T1.performedorguid                                                                                                                          
AND T.investigationid = T1.performedorggroupid                                                                                                                    
WHERE  T1.invtype = 'INV'                                                                                                                   
END                                                                                               
                                                                                                                          
DECLARE @tblTempGrp TABLE                                                                                                                          
(                                                                                                                          
invid  VARCHAR(10),                                                                                                                          
grpid       VARCHAR(10),                            
accessionno          VARCHAR(10),                                                                                                                          
parentgrpid      VARCHAR(10),                                                                                                                          
isgroup              CHAR(1),                                                                                                  
atlevel              INT,                                                                                                                          
grpcontentseq        INT,                                        
[uid]      VARCHAR(500),                            
patientvisitid       BIGINT,                                                                                               
actualgrpid          BIGINT,                                                                                             
deptname             VARCHAR(255),                                        
methodname      VARCHAR(255),                                                                                      
notes                VARCHAR(max),                                                    
referencerange       VARCHAR(max),                                                                                                     
           PrintableRange        VARCHAR(max),        
sampleid             BIGINT,                                                                                                                          
samplename           VARCHAR(500),                  
uomcode              VARCHAR(100),                                                                              
comments             VARCHAR(max),                                                      
pkgid                INT,                                                
packagename          VARCHAR(255),                                                                                                                          
childprintseparately CHAR(1),                                                                                                                          
convreferencerange   NVARCHAR(max)                                  
)                                                                                             
DECLARE @tblOrdInvExploded TABLE                                                                                                                         
(                                                                                                                          
invid                VARCHAR(10),                                                                                     
grpid                 VARCHAR(10),                                              
accessionno           VARCHAR(10),                                                                                                                          
parentgrpid           VARCHAR(10),                                                                                                                          
deptid                BIGINT,                              
grpdeptid             VARCHAR(10),                                                                                                                          
isgroup            CHAR(1),                                                                                                                          
atlevel               INT,                                                                           
deptseq               INT,                                                                                                                          
firstlvlseq           INT,                                      
grpcontentseq         INT,                                                 
rootgroupid           VARCHAR(10),                                                                                                                          
innercontentseq       INT,                                                                                                                          
uid          VARCHAR(500),                                             
patientvisitid        BIGINT,                                                                                      
actualgrpid           BIGINT,                                                                                                                          
deptname              VARCHAR(255),                                                            
methodname            VARCHAR(500),                                                                                                                          
notes                 VARCHAR(max),                                                                          
referencerange        VARCHAR(max),                        
           PrintableRange        VARCHAR(max),        
sampleid              BIGINT,                                   
samplename            VARCHAR(500),                                                                                                     
uomcode               VARCHAR(255),                                                             
comments              VARCHAR(max),                                                                              
patternid             BIGINT,                                                                           
patternname VARCHAR(200),                                            
uomid            INT,                                                                                                                          
validationtext        VARCHAR(max),                                    
isabnormal            VARCHAR(50),                                         
invvalidationtext     VARCHAR(max),                                                       
[groupcomment]        [VARCHAR](255),                                                                                                            
[groupmedicalremarks] [VARCHAR](255),                                                                                                                          
resultvaluetype       NVARCHAR(200),                                                                  
decimalplaces         INT,                                                                                                                          
pkgid                 INT,                                                             
packagename           VARCHAR(255),                                                            
rootgrpname           VARCHAR(250),                                                                                                                          
result                VARCHAR(max),                                                                                                                       
medicalremarks        NVARCHAR(max),                                                                                                                          
l2contentseq          INT,                                                                                          
parentgrpname         VARCHAR(250),                                                                  
isnonreportable       CHAR(1),                                                                                          
parentprintseparately CHAR(1),                                                     
parentpagenumber      INT,                                                                                                                          
childprintseparately  CHAR(1),                                                                                                                          
childpagenumber       INT,                                                                                                                          
isrejected            CHAR(1),                                                                                                                          
referredtype          VARCHAR(50),                                        
convreferencerange    NVARCHAR(max),                                                                                           
convresult            VARCHAR(max),                                                                                                      
iswithheld  CHAR(1),       
newvalue              NVARCHAR(20) ,                                                              
ConvUOMCode        varchar(50),                                                                        
[OtherLanguage] NVarchar(200),                                                                        
[OtherLanguageHeader] NVarchar(200)                                                                        
)                                                                  
DECLARE @tblSeq TABLE                               
(                                            
invid         VARCHAR(10),       
grpid         VARCHAR(10),                                                                                                                          
accessionno   VARCHAR(10),                                        
parentgrpid   VARCHAR(10),                                                                                                              
deptid    VARCHAR(10),                                                                     
explodedseq   INT,                                                                                                               
overallseq    INT,                                 indcontentseq INT     
)                                                                                                  
/****************** Explode the Groups ordered to get the investigation to be performed along with the levels *********************************/                                                                                                              



  
    
    
    
      
      
      
      
        
          
            
;                                                                                                                          
                                                                                                                 
WITH c1                                                                                                                          
AS (SELECT OI.id                           AS GrpID,                                    
IGM.investigationid             AS InvID,                                     
OI.id                           AS ParentGrpID,                                                                                 
IGM.parent,                                                                                                                          
OI.accessionnumber,                                                                                                                          
0                               AS [level],                                  
IGM.sequenceno,                                                                                                                          
OI.[uid],                                                                             
OI.visitid,                                     
CONVERT(BIGINT, IOG.orggroupid) AS OrgGroupID,                                                                                                                          
''      AS DeptName,                                                                                                         
''                              AS MethodName,                                                      
''           AS Interpretation,                                                                    
''                              AS ReferenceRange,                                                                                                                          
                      ''                              AS PrintableRange,        
''                              AS SampleID,                                                                                  ''       AS Reason,                                                                                  
       
        
          
           
              
                
                                     
IGM.printseparately             AS ChildPrintSeparately,                      
''                              AS ConvReferenceRange                                                                                                      
FROM   orderedinvestigations OI WITH(nolock)                                                                                                                          
INNER JOIN invorggroup IOG WITH(nolock)                                                          
ON IOG.attgroupid = OI.id                                                                             
AND OI.orgid = IOG.orgid                                                             
INNER JOIN invgroupmapmaster IGM WITH(nolock)                                                                  
ON IOG.orggroupid = IGM.groupid                                                                                         
INNER JOIN @tblResultSelectID TRS                                                 
ON TRS.accessionno = OI.accessionnumber                
WHERE  OI.type = 'GRP'                                                                                                                          
UNION ALL                                                                                    
SELECT CONVERT(BIGINT, IOG.attgroupid) AS GrpID,                                                                                                                          
IGM.investigationid             AS InvID,                                                   
OI.grpid                        AS ParentGrpID,                                                                                
IGM.parent,                                                                                     
OI.accessionnumber,                                                                    
[level] + 1,                                                                                                                
CASE                                                                                                                          
WHEN OI.grpid IN(SELECT OI1.id                                                                                                                          
FROM   orderedinvestigations OI1 WITH(nolock)                                                                                                                
WHERE  type = 'GRP') THEN OI.sequenceno                                                                                                
ELSE OI.sequenceno                                          
--+ 1 -- + [level]                                                                                                                                    
END                             AS SequenceNo,                                                                                                       
OI.[uid],                                                                                                              
OI.visitid,                                                                                                                          
OI.invid     AS OrgGroupID,                                                                                                                          
methodname,                                
interpretation,                   
referencerange,                                                                                                                          
                      PrintableRange,        
sampleid,                    
'',                                                                                                                          
reason,     
IGM.printseparately             AS ChildPrintSeparately,                                                                                                                          
convreferencerange                                                                                                                          
FROM   c1 OI                                             
INNER JOIN invorggroup IOG WITH(nolock)                                                                                        ON IOG.orggroupid = OI.invid                                                           
AND IOG.orgid = @OrgID                                                                                                                          
INNER JOIN invgroupmapmaster IGM WITH(nolock)                                                               
   
ON OI.invid = IGM.groupid                                                                                                                          
INNER JOIN @tblResultSelectID TRS              
ON TRS.accessionno = OI.accessionnumber                                                                                                                          
WHERE  OI.parent = 'Y')                                                                                               
INSERT INTO @tblTempGrp                                                                                                                          
(invid,                                                                                               
grpid,                                                                                         
accessionno,                                                               
parentgrpid,                                                                                                            
isgroup,                                                                                              
atlevel,                                                                                                                          
grpcontentseq,                                                                                                                          
[uid],                                                                                                                          
patientvisitid,                                                         
actualgrpid,                                                                
deptname,           
methodname,                                                                                                                          
notes,                  referencerange,                                                  
                   PrintableRange,        
sampleid,                                                                                                                          
samplename,                                                                                                                          
uomcode,                                     
comments,                                                                                                                    
pkgid,                                                                                                                          
packagename,                                                                                      
childprintseparately,                                                      
convreferencerange)                                                                                                                       
SELECT invid,                                                                                    
grpid,                                                                                                     
accessionnumber,                          
parentgrpid,                      
'Y',                                                                                                                          
[level],                                                                                                                          
sequenceno,                                                                                                                          
uid,                  
visitid,                                   
orggroupid,                                 
deptname,                                                                                                    
methodname,                                                                                       
interpretation,                                  
referencerange,                                                                                                                          
             PrintableRange,        
sampleid,                                                       
'',                                                        
'',                                                                                                                      
reason,                                                                                                 
0,                                                                                                                   
'',                                                 
childprintseparately,                                                                                          
convreferencerange                                          
FROM   c1                                                                                                   
WHERE  Isnull(parent, 'N') = 'N'                                    
ORDER  BY parentgrpid                                                                                      
                                                                                                                          
----------------                                                                                                                                                                                                       
DECLARE @InvGroupMapMasterForOrderedPkg TABLE                                                                                    
(                                                                                                            
groupid              INT,                                                                                                                          
investigationid      BIGINT,                                                                                                                   
parent               VARCHAR,                                                                                                     
sequenceno           INT,                                                                                                                
childprintseparately CHAR(1)                                                                                                                          
)                                                                                                                          
                                                                                           
INSERT INTO @InvGroupMapMasterForOrderedPkg               
SELECT IOG.orggroupid,                                                                                                                       
IPM.id,                                                                                                                          
CASE                                                                             
WHEN IPM.type = 'GRP' THEN 'Y'                                                                                                   
ELSE 'N'                                                                                                                          
END AS Parent,                                                                                                                          
IPM.sequenceno,                                                                  
IPM.printseparately                                                                                                                          
FROM   orderedinvestigations OI WITH(nolock)                                                                                                                          
INNER JOIN invorggroup IOG WITH(nolock)                                                                                                              
ON IOG.attgroupid = OI.id                                                                   
AND IOG.orgid = OI.orgid          
INNER JOIN invpackagemapping IPM WITH(nolock)                       
ON IPM.packageid = IOG.orggroupid                                                                                                                          
AND IPM.type IN( 'INV', 'GRP' )                                                                                      
INNER JOIN @tblResultSelectID TRS                                                                                                
ON TRS.accessionno = OI.accessionnumber                                                                                                                          
WHERE  OI.type = 'PKG';                                                                                    
                                
WITH c2                                                                                                                          
AS (SELECT CONVERT(BIGINT, 0)                               AS                                                                                                                          
GrpID,                                                                                                                          
IGM.investigationid                                    AS                                                                                             
InvID,                                                                                                                          
OI.id                                                  AS                                                                                                                          
ParentGrpID                                                                                                  
,                             
CONVERT(VARCHAR, IGM.parent)                           AS                                                                    
Parent,                                                       
OI.accessionnumber,                                  
0                                                      AS                                                                                                                          
[level],                                                                                                            
IGM.sequenceno,                                                                                                                          
OI.[uid],                                                  
OI.visitid,                                                                                                                          
CONVERT(BIGINT, IOG.orggroupid)                        AS                  OrgGroupID,          
      
      
      
      
        
          
            
              
                
                  
                    
''  AS                                                                         
DeptName,                                                                                                                          
''                                                     AS                         
MethodName,                                                             
''                                                     AS                                                       
Interpretation                                                                                                                          
,                                                                                                        
''                                                     AS                                               
ReferenceRange,                                   
 ''                                                     AS PrintableRange,                                  
''                                              AS                                                           
SampleID,                                
''                                                    AS                                    
Reason                                                                                                                          
,                                                                           
OI.id                                                                                                                          
AS PkgID,                                                                                                                          
OI.name                      AS                                                                                                                          
PackageName                                                                                                                          
,                                       
Cast(Isnull(IGM.childprintseparately, 'N') AS CHAR(1)) AS                                          
ChildPrintSeparately,                                    
''  AS                                                                                
ConvReferenceRange                                                                                                                          
FROM   orderedinvestigations OI WITH(nolock)                                                                                                                          
INNER JOIN invorggroup IOG WITH(nolock)                                                                       
ON IOG.attgroupid = OI.id                                                                                                                          
AND OI.orgid = IOG.orgid                                                                                  
INNER JOIN @InvGroupMapMasterForOrderedPkg IGM                                                                                                     
ON IOG.orggroupid = IGM.groupid                                                                                                              
INNER JOIN @tblResultSelectID TRS                                                                          
ON TRS.accessionno = OI.accessionnumber                                                                                             
WHERE  OI.type = 'PKG'                                                                                                        
UNION ALL                               
SELECT CONVERT(BIGINT, IOG.attgroupid)                       AS                                                                  
GrpID,                                                                                                                          
IGM.investigationid                  AS                                                                                                                          
InvID,                                         
OI.grpid         AS                      
ParentGrpID,                                          
CONVERT(VARCHAR, IGM.parent)                          AS                                                                                                   
Parent,           
OI.accessionnumber,                                                                                                                          
[level] + 1,                                                                                                                     
CASE                                                                                                   
WHEN OI.grpid IN(SELECT OI1.id                                   
FROM   orderedinvestigations OI1 WITH(nolock)                                                                                                                          
WHERE type = 'PKG') THEN OI.sequenceno                                                   
ELSE OI.sequenceno                                                            
--+ 1 -- + [level]                                                                                                                                      
END                                                   AS                                                                                                      
SequenceNo,                                                                OI.[uid],                                                                                                                          
OI.visitid,                                                                                                                          
OI.invid                                        AS                                                                                                                          
OrgGroupID,                                                                   
methodname,                                                                                                                          
interpretation,                                                                                                                          
referencerange,                                                                                                                          
                      PrintableRange,        
sampleid,                                                                                                                          
'',                                                                                     
reason,                                                                               
pkgid,                                                        
packagename,                                 
Cast(Isnull(OI.childprintseparately, 'N') AS CHAR(1)) AS                                                                                                                          
ChildPrintSeparately,                                                                                                    
convreferencerange                                                                                                                          
FROM  c2 OI                                                                                                                          
INNER JOIN invorggroup IOG WITH(nolock)                                                                                                
ON IOG.orggroupid = OI.invid                                                                                                                         
AND IOG.orgid = @OrgID                                                                                                                          
INNER JOIN invgroupmapmaster IGM WITH(nolock)                                     
ON IGM.groupid = OI.invid                                                                                                                          
INNER JOIN @tblResultSelectID TRS                                                                                                       
ON TRS.accessionno = OI.accessionnumber                                                                                                                          
WHERE  OI.parent = 'Y')                                                       
INSERT INTO @tblTempGrp                                                                     
(invid,                   
grpid,                                                                        
accessionno,                                                                
parentgrpid,                                                                      
isgroup,                                                                                                                          
atlevel,                                                                                                             
grpcontentseq,                                                                                                                
[uid],                                                                                                         
patientvisitid,                                                                                                               
actualgrpid,                                                                                            
deptname,                                                                                                                  
methodname,                                                                  
notes,                                                                                                                          
referencerange,                                                                                                                          
                   PrintableRange,        
sampleid,                                                                                   
samplename,                                          
uomcode,                                                                                                        
comments,                                                                                                          
pkgid,                                                                                                          
packagename,                                                                                                                          
childprintseparately,                                                              
convreferencerange)                                                                                                                          
SELECT invid,                                                                                                        
grpid,                                                                                                                          
accessionnumber,                                                                               
parentgrpid,                                                                     
'Y',                                              
[level],                                                                                                                          
sequenceno,          uid,                                                                   
visitid,                                                                 
orggroupid,                                                                                                                          
deptname,                                                                                                                  
methodname,                                                                                                                          
interpretation,                                                         
referencerange,                                                                                                              
             PrintableRange,        
sampleid,                                                                                  
'',                                    
'',                                                                                                                          
reason,             
pkgid,                                                    packagename,                                                                                                                          
childprintseparately,                                                                                                                          
convreferencerange                                                                                                                          
FROM   c2                                                          
WHERE  Isnull(parent, 'N') = 'N'                                                                                                                          
ORDER  BY parentgrpid                    
                                                          
----------------                                                                                                                
/****************** Explode the Groups ordered to get the investigation to be performed along with theie levels *********************************/                                                                                                /********** 



  
    
    
    
      
      
      
      
        
          
            
              
                
                  
                    
                      
                        
                          
Insert ordered investigations and exploded group contents into a temp table *******************************************************/                                                                                                                          




INSERT INTO @tblOrdInvExploded                                                                                                                          
(invid,                                                                                                                          
grpid,                                 
accessionno,                                                                                                                          
parentgrpid,                                                                                         
deptid,                                                                                                                          
grpdeptid,                                                                    
isgroup,                 
atlevel,                                             deptseq,                                                       
firstlvlseq,                                                                            
grpcontentseq,                                                                                                                          
rootgroupid,                                                                                                                          
innercontentseq,                              
uid,                                                                                           
patientvisitid,                                                                                                                          
actualgrpid,                                                                                                                          
deptname,     
methodname,                                                                      
notes,                                                                                                                          
referencerange,                                                                  
          PrintableRange,        
sampleid,                        
samplename,                                                                                                                          
uomcode,                                                                                              
comments,                                                                                           
patternid,                                                                                                                          
patternname,                                
uomid,                                                                                                                          
validationtext,                                                                                                                          
invvalidationtext,                                             
groupcomment,                                              
groupmedicalremarks,                                                                                                                   
resultvaluetype,                                                                                                                          
decimalplaces,                                                                                                                          
pkgid,                                                                                    
packagename,                                                                                                                          
medicalremarks,                                                                                                                       
isnonreportable,                                                                      
childprintseparately,                                                                                
parentprintseparately,                                                                                                                          
referredtype,                                                                                      
convreferencerange)                                                                                                                          
SELECT OI.id,                                                                                                     
'0',                                                                                                                          
OI.accessionnumber,                                                                                                      
'0',                                                              
IOM.deptid,                                                                                        
IOM.deptid,                                                                                                                          
'N',                                                                                                                          
0,                                        
0,                                                                                                                          
IOM.sequenceno,                                                                                                            
0,                                                                                                                       
'',                              
0,                                                                    
OI.uid,                                                  
OI.visitid,                                                                                                                          
0,                                    
IDM.deptname,         piv.methodname,                                         
PIV.interpretation,           
PIV.referencerange,                                                                                              
             Piv.printablerange,        
PIV.sampleid,                       
'',                                                                                                                          
'',                                                                                                                          
reason,                                     
0,                                  
'',                           
IOM.uomid,                                                                                                                          
'',                                                 
'',                                                                                                                          
groupcomment,                                                                    
groupmedicalremarks,                                                                                                                          
'',                                                                                                                          
0,                                                                                                                          
0,                                                                                                                     
'',                                                               
PIV.medicalremarks,                                       
IOM.isnonreportable,                                                                                                                          
'',                                                                                                     
IOM.printseparately,                                                                                                               
OI.referredtype,                                                                               
PIV.convreferencerange                                                                                                             
FROM   orderedinvestigations OI WITH(nolock)                                                                                                                          
INNER JOIN investigationorgmapping IOM WITH(nolock)                          
ON OI.id = IOM.investigationid     
AND OI.orgid = IOM.orgid                                     
INNER JOIN invdeptmaster IDM WITH(nolock)                                                         
ON IDM.deptid = IOM.deptid                                                                                                                          
AND OI.orgid = IDM.orgid                                                                                                                          
INNER JOIN @tblPatientInvestigation PIV        
ON Piv.investigationid = IOM.investigationid                                                                                          
AND piv.patientvisitid = OI.visitid                                                                                                                          
AND PIV.uid = oi.uid                                                        
INNER JOIN @tblResultSelectID TRS                                        
ON TRS.accessionno = OI.accessionnumber                                                                                               
WHERE  type NOT IN( 'GRP', 'PKG' )                                                                                                     
UNION                             
SELECT OI.id,                                                                       
'0',                               
OI.accessionnumber,                                     
'0',                                                     
0,                                                                                                        
0,                                                               
'N',                                                                                                                          
0,                                                   
0,                                       
IOM.sequenceno,                                     
0,                                                                                                                          
'',                                                                         
0,                                                                              
OI.uid,                        
OI.visitid,                                                                                                                          
0,                                                                                                                          
'',                                                                                                                          
piv.methodname,                            
PIV.interpretation,                                                                            
PIV.referencerange,                                                                                                                          
             PIV.PrintableRange,        
PIV.sampleid,                                                                     
'',                                                                                                                          
'',                                                                                                                          
reason,                                     
0,                                                                                                                          
'',           
IOM.uomid,                                                                                  
'',                                                                                                                          
'',                                                                                                  
groupcomment,    
groupmedicalremarks,                                                                                                    
'',                                          
0,                                                                                          
0,                                                                                      
'',                                     
PIV.medicalremarks,                                                                                                                          
IOM.isnonreportable,                                                                                        
'',                    
IOM.printseparately,                                                                                                                          
OI.referredtype,                                                                PIV.convreferencerange                              
FROM   orderedinvestigations OI WITH(nolock)                                                
INNER JOIN investigationorgmapping IOM WITH(nolock)                                                                                                                          
ON OI.id = IOM.investigationid 
AND OI.orgid = IOM.orgid                                                                    
--LEFT join InvestigationHeader IH on IH.HeaderID=IOM.HeaderID                                                                                                                                                                                                



  
    
    
    
      
      
      
      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                
                                      
                                        
                                          
                                            
                                              
                                                
                                                  
                                                    
                                                      
        
                                                                              
                                                              
                                   
                                                                  
                                                         
                                                                      
                                                     
                                                                          
                                                                            
                                                                
                    
                                                                                  
                                                      
                                                                                      
                                                                                        
                                                                                          
                                                                                      
                                                                                              
                                                    
                                                                                                 
                          
                                                                
                                                                                                        
                                                                                                         
INNER JOIN @tblPatientInvestigation PIV                                                                                                                          
ON Piv.investigationid = IOM.investigationid                         
AND piv.patientvisitid = OI.visitid                                                                                                                          
AND PIV.uid = oi.uid                                                                                                                          
INNER JOIN @tblResultSelectID TRS                                                                         
ON TRS.accessionno = OI.accessionnumber                                                                    
WHERE  type NOT IN( 'GRP', 'PKG' )                                                                                                    
UNION                                                                                                                      
SELECT invid,                                                                                            
grpid,                    
accessionno,                                                                         
parentgrpid,                                                                                                                '0',                                                                    
'0',                                                           
isgroup,                                                                               
atlevel,                                                         
0,                                                                                                                          
0,                                 
grpcontentseq,                                                  
'',                                                                                            
0,                                                                                                                          
uid,                                                                                                                          
patientvisitid,                                                           
actualgrpid,                                        
deptname,                                                                                                                          
methodname,                                                                                                                         
notes,                                                                                                                          
referencerange,              
             PrintableRange,        
sampleid,                                                                                                                          
'',                                                                                            
'',                                                
comments,                                                                                                                          
0,                                                                                                                          
'',                             
0,                                                                                                                          
'',         
'',                                                            
'',                                                                                                                 
'',                                                                                                                          
'',                0,                                                                             
pkgid,                 
packagename,                               
'',                                                                                                                          
'N',                                                                                                      
childprintseparately,                                                                              
'',                                                                            
'',                           
convreferencerange                                                                                                                          
FROM   @tblTempGrp           
--sathish added this to arrage albumin seq when ordered renal profile grp        
if exists (select 1 From @tblOrdInvExploded   where invid=4731 and grpid=11 )          
begin          
delete from @tblOrdInvExploded where invid=4731 and grpid<>11          
end                                  
-- sathish code ends                                                       
UPDATE t                    
SET    methodname = PIV.methodname,                                                                                                                      
notes = PIV.interpretation,                                                                                                                          
referencerange = PIV.referencerange,                                                                  
             PrintableRange = PIV.PrintableRange,        
comments = reason,                                                                                                                          
deptid = IM.deptid,                                                            
deptname = IDM.deptname,                                                                                           
t.samplename = ISm.sampledesc,                                                                                       
patternid = PM.patternid,                                                                                                                          
patternname = IPM.patternname,                                                                                                           
uomid = IM.uomid,                                                                                    
uomcode = IM.uomcode,                                                                                                                          
isabnormal = PIV.isabnormal,                                                                                                              
invvalidationtext = Isnull(IM.invvalidationtext, ''),                                                                                         
groupcomment = PIV.groupcomment,                                                                                                                          
groupmedicalremarks = PIV.groupmedicalremarks,                                                                                                         
resultvaluetype = Isnull(IOA.resultvaluetype, 'AN'),                                                                                                               
decimalplaces = IOA.decimalplaces,                                                                                                                          
medicalremarks = PIV.medicalremarks,                                                                                                 
isnonreportable = IM.isnonreportable,                                                                                                  
t.patientvisitid = piv.patientvisitid,                                                                                                                         
t.convreferencerange = PIV. convreferencerange                                                                                  
FROM   @tblOrdInvExploded T                                                                                                                          
INNER JOIN @tblPatientInvestigation PIV                                                                                   
ON Piv.investigationid = t.invid                                                                                                             
AND piv.patientvisitid = t.patientvisitid                                                                                 
AND PIV.uid = t.uid                                                   
INNER JOIN investigationorgmapping IM WITH(nolock)                                                                                    
ON T.invid = IM.investigationid                                                                                         
AND IM.orgid = @OrgID                                                                                                               
LEFT JOIN invsamplemaster ISm WITH(nolock)                                             
ON ism.samplecode = PIV.sampleid                                                                                                                          
AND ism.orgid = @OrgID                                                                                                                          
AND ISm.orgid = PIV.orgid                                                                  
INNER JOIN invdeptmaster IDM WITH(nolock)                                           
ON IDM.deptid = IM.deptid                                                                          
AND IM.orgid = IDM.orgid                                                       
INNER JOIN patternmapping PM WITH(nolock)                                                                                                                          
ON PM.investigationid = t.invid                                                                                     
INNER JOIN investigationpattern IPM WITH(nolock)                                                                                                                          
ON ipm.patternid = PM.patternid                                
AND ipm.orgid = @OrgID                                                                            
LEFT JOIN investigationorgattributes IOA WITH(nolock)                                                                                                                          
ON IOA.orgid = @OrgID                                                                                   
AND IOA.investigationid = IM.investigationid                                                                                               
                                                                                                
UPDATE t                                                                                                                          
SET    t.groupid = t.packageid,                                                                                                                          
t.groupname = Isnull(IOG.displaytext, IG.groupname)                                         
FROM   @tblPatientInvestigation T                                                    
INNER JOIN invorggroup IOG                                                                                          
ON IOG.orggroupid = T.packageid                                        
AND IOG.orgid = T.orgid                                                                                                                          
INNER JOIN invgroupmaster IG                                                                                                                          
ON IG.groupid = IOG.attgroupid                                                                      
WHERE  t.packageid > 0                                                                        
AND ( t.groupid = 0                                                                                                                 
OR t.groupid IS NULL )                                                                                                                     
                                                                                                                          
/*********************** Update the departments for all the investigations ***********************/                        
/*************************************** Get the Root GroupID for all the Groups/Inner Groups **********************************************/                            
DECLARE @tblRootGrpID TABLE                                                                            
(                                                                                      
accessionno VARCHAR(10),                                 
parentgrpid VARCHAR(10)                        
)                                                                                                                    
                                                                                                
INSERT INTO @tblRootGrpID                                                                                                    
SELECT accessionno,                                                                
parentgrpid                                                                                                                          
FROM   @tblOrdInvExploded                                                                                                                          
--WHERE Atlevel=0                                                                                                                                 
GROUP  BY accessionno,                                                                                     
parentgrpid                                                                                                                          
                                           
UPDATE t                                                          
SET    t.parentgrpid = t.grpid                                                                                                
FROM   @tblOrdInvExploded T                                        
WHERE  t.atlevel = 1                                                                                           
                                                                                                                          
UPDATE t                                                                                                                          
SET    t.parentgrpname = Isnull(IOG.displaytext, IGM.groupname)                                                                                              
FROM   @tblOrdInvExploded T                                                                     
INNER JOIN invgroupmaster IGM                                                                                                                
ON IGM.groupid = T.parentgrpid                                   
INNER JOIN invorggroup IOG                                                                                              
ON IOG.attgroupid = IGM.groupid                                              
AND IOG.orgid = @OrgID                                                                                                                
WHERE  IOG.orgid = @OrgID                                                                                                                          
                                              
UPDATE t                                                           
SET    t.rootgroupid = T1.parentgrpid,                                                                                                                          
t.parentprintseparately = Isnull(IOG.printseparately, 'N')                                                                                                    
FROM   @tblOrdInvExploded T                                                                                                                          
INNER JOIN @tblRootGrpID T1                                                                                                                          
ON T.accessionno = T1.accessionno                                                                                                                          
INNER JOIN orderedinvestigations OI WITH(nolock)                  
ON OI.accessionnumber = T1.accessionno                                   
AND T1.parentgrpid = OI.id                                                                                                           
INNER JOIN invorggroup IOG WITH(nolock)                        
ON IOG.attgroupid = OI.id                                                                      
AND IOG.orgid = @OrgID                            
WHERE  OI.type IN( 'GRP', 'PKG' )                                                                                                                            
UPDATE t                                                                                                               
SET    t.rootgrpname = T1.name                                          
FROM   @tblOrdInvExploded T                                                                                                                          
INNER JOIN orderedinvestigations T1 WITH(nolock)                                                                          
ON T.accessionno = T1.accessionnumber                                                                                                                          
AND T.rootgroupid = T1.id                                                                                                           
                                                                                                      
/*************************** RootGroup populating ends ********************************************************************/                                                                                                                          
/******************************************* Assign DeptID for Groups based on Max no. depts in a group ************************************/                                                                         
DECLARE @tblDeptGrp TABLE                                                                                                                          
(                                                                                                                          
parentgrpid VARCHAR(10),                                                                                                                          
deptid VARCHAR(10),                                                                               
deptcnt     INT                                                                                
)                                                                                                                    
DECLARE @tblDeptGrpAdjusted TABLE                                                          
(                                                                                                                          
parentgrpid VARCHAR(10),                                                                                                  
deptid      VARCHAR(10)                                                 
)                                                                                                               
                                                                          
INSERT INTO @tblDeptGrp                                                                        
SELECT parentgrpid,                              
deptid,                                                                                                                          
Count(deptid)                                                              
FROM   @tblOrdInvExploded                                                    
WHERE  parentgrpid != '0'                                                                                            
AND Isnull(parentgrpid, '') <> ''                   
AND deptid != '0'                                                                                                                          
GROUP  BY parentgrpid,                                                                                            
deptid                                                                                                                          
ORDER BY parentgrpid                                                      
                                        
INSERT INTO @tblDeptGrpAdjusted                                      
SELECT parentgrpid,                                                                                          
Min(deptid)                                                                                                                          
FROM   @tblDeptGrp t1                                                                                                  
WHERE  deptcnt = (SELECT Max(deptcnt)                                                                                     
FROM   @tblDeptGrp t2                                                                                  
WHERE  t2.parentgrpid = t1.parentgrpid)                                                                             
GROUP  BY parentgrpid                                                                                                                          
                                                                                    
UPDATE t                                                      SET    t.grpdeptid = T1.deptid              
FROM   @tblOrdInvExploded T                         
INNER JOIN @tblDeptGrpAdjusted T1                                                                                                                          
ON T.parentgrpid = T1.parentgrpid                                                                                                                 
                                                                                          UPDATE t                                                                                                          
SET    t.deptname = T1.deptname,                         
t.deptid = T1.deptid                                                                                                                          
FROM   @tblOrdInvExploded T                                                                                                                          
INNER JOIN invdeptmaster T1                                                              
ON T1.deptid = T.grpdeptid                                                                                                                          
AND T1.orgid = @OrgID                                                                                    
                                                                                                                          
UPDATE @tblOrdInvExploded                                                                                 
SET    grpdeptid = deptid                                                                                                                          
WHERE  grpdeptid = '0'                                                                                                                  
                                                                     
/******************************************* Assign DeptID for Groups based on Max no. depts in a group ************************************/                                                                                                                 



  
    
    
    
      
      
      
      
        
         
/******************************************* Update Dept Sequence ************************************/                                                                                 
UPDATE t                                                                       
SET    t.deptseq = D.sequenceno                                                                          
FROM   @tblOrdInvExploded T                                                                                                                          
INNER JOIN invdeptmaster D WITH (nolock)                                       
ON T.grpdeptid = D.deptid                          
                                                                                                                          
/******************************************* Update Dept Sequence ************************************/                      /* Order Investigation by seq */                                                                                             
UPDATE t                                                                                                                          
SET    t.firstlvlseq = IOG.sequenceno                                                           
FROM   @tblOrdInvExploded T                                                                                                
INNER JOIN investigationorgmapping IOG                                                                              
ON T.invid = IOG.investigationid                                                              
AND IOG.orgid = @OrgID                                                                                                                          
WHERE  t.isgroup != 'Y'                                                       
                                                                                                                          
/* Order Group by group Seq */                                                                                         
UPDATE t                                                                                             
SET    t.firstlvlseq = IOG.sequenceno,                                             
validationtext = iog.validationtext                                                                                                                          
FROM   @tblOrdInvExploded T                                                                                      
INNER JOIN invorggroup IOG                
ON T.rootgroupid = IOG.attgroupid                                                                                                        
AND IOG.orgid = @OrgID                         
                                                            
--select * from @tblInvestigationValues                                                        
/* Order Inner Content Sequence */                                                 
UPDATE t                                                                                                                          
SET    innercontentseq = IGM.sequenceno                                                                                                                          
FROM   @tblOrdInvExploded T                                                                                                       
INNER JOIN invorggroup IOG                                                                                                                          
ON IOG.attgroupid = t.grpid                                                                                                                          
AND IOG.orgid = @OrgID                                                                                                     
INNER JOIN invgroupmapmaster IGM                       
ON IGM.groupid = IOG.orggroupid                                                                                                                     
AND T.invid = IGM.investigationid                                                                                                           
WHERE  t.atlevel IN( 0, 1 )                                                                                                                  
            
UPDATE t                                                      
SET    innercontentseq = IGM.sequenceno                                                                                     
FROM   @tblOrdInvExploded T                                                                          
INNER JOIN invorggroup IOG                                                                                       
ON IOG.attgroupid = t.parentgrpid                                                                                                                
AND IOG.orgid = @OrgID                                                                                                                          
INNER JOIN invgroupmapmaster IGM                        
ON IGM.groupid = IOG.orggroupid                                                                   
AND IGM.investigationid = t.actualgrpid                    
WHERE  t.atlevel IN( 2 )                                                                                                                          
                                                                                                                          
UPDATE t                                        
SET    l2contentseq = IGM.sequenceno,                                                                                                                          
validationtext = iog.validationtext                                                                                                                          
FROM   @tblOrdInvExploded T                                                                                                                
INNER JOIN invorggroup IOG                                                                               
ON IOG.orggroupid = t.actualgrpid                                                               
AND IOG.orgid = @OrgID                                                                                                                    
AND T.atlevel = 2                                                                                               
INNER JOIN invgroupmapmaster IGM                                                                                                                           
ON IGM.groupid = T.actualgrpid                                               
AND T.invid = IGM.investigationid                                                      
AND T.atlevel = 2                                                                        
                                                                                                                          
UPDATE t1                                                                            
SET    t1.result = t2.value,                                                                                                                          
t1.newvalue = t2.newvalue,                                   
t1.convresult = t2.convvalue ,           
t1.ConvUOMCode=t2.ConvUOMCode                                                                                         
--  + Case When t1.ReferredType='Recheck' Then ' (RC)' When t1.ReferredType='Retest' Then ' (RT)' Else '' End                                                                        
FROM   @tblOrdInvExploded t1                                                                                   
INNER JOIN @tblInvestigationValues t2                                                                                                                          
ON t1.invid = t2.investigationid                                                                                                     
AND ( t1.actualgrpid = t2.groupid                                           
OR t1.grpid = t2.groupid )                                   
AND Isnull(t1.pkgid,0) = Isnull(t2.packageid,0)                                                                                                                                       
AND t1.uid = t2.uid                                                                                                                          
AND t2.status NOT IN( 'Reject', 'With Held' )                                 
                                                                                                                          
UPDATE t1                                                                                                                          
SET    t1.result = '-',                                                        
t1.referencerange = '-',        
t1.uomcode = '',                                                                                       
t1.isrejected = 'Y',                                           
t1.convresult = '-',                                                                                                 
t1.convreferencerange = '-'                                                                                                                          
FROM   @tblOrdInvExploded t1                                                         
INNER JOIN @tblInvestigationValues t2                                                                      
ON t1.invid = t2.investigationid                                                                                                  
AND ( t1.actualgrpid = t2.groupid                                                                                      
OR t1.grpid = t2.groupid )                                                                                                                          
AND Isnull(t1.pkgid,0) = Isnull(t2.packageid,0)                                                                                        
AND t1.uid = t2.uid                                                                                                                          
AND t2.status IN( 'Reject' )                                                                                                                 
                                                                                   
UPDATE t1                                                                                                                          
SET    t1.result = '-',                                                                                                                        
t1.referencerange = '-',                            
t1.uomcode = '',                                                                                                                          
t1.iswithheld = 'Y',                                                                                                                          
t1.convresult = '-',                                
t1.convreferencerange = '-'                                                         
FROM   @tblOrdInvExploded t1                                                                      
INNER JOIN @tblInvestigationValues t2                                          ON t1.invid = t2.investigationid                                                                                                                          
AND ( t1.actualgrpid = t2.groupid                                                                                          
OR t1.grpid = t2.groupid )                                                                                    
AND Isnull(t1.pkgid,0) = Isnull(t2.packageid,0)         
AND t1.uid = t2.uid                           
AND t2.status IN( 'With Held' )                                           
                      
UPDATE t                                                                                 
SET    t.childprintseparately = Isnull(IGM.printseparately, 'N')                                                                                                                          
FROM   @tblOrdInvExploded T                                                                                                                          
INNER JOIN invorggroup IOG                                                                               
ON IOG.attgroupid = T.rootgroupid                                                                       
AND IOG.orgid = @OrgID                                                                                                                          
INNER JOIN invgroupmapmaster IGM                                   
ON IGM.groupid = IOG.orggroupid                           
AND IGM.parent = 'Y'                                                                                                                          
AND IGM.investigationid = T.actualgrpid                                                                                                                          
                       
UPDATE t                                                                                             
SET    t.childprintseparately = Isnull(IGM.printseparately, 'N')                                                     
FROM   @tblOrdInvExploded T                                                                                        
INNER JOIN invorggroup IOG                                                                                                                       
ON IOG.attgroupid = T.rootgroupid                                             
AND IOG.orgid = @OrgID                                                                                                                          
INNER JOIN invgroupmapmaster IGM                                                 
ON IGM.groupid = IOG.orggroupid                    
AND IGM.parent = 'Y'                                                                                                                          
INNER JOIN invorggroup IOG1                                                                                                                   
ON IOG1.orggroupid = IGM.investigationid                                                                                                                          
AND IOG1.orgid = @OrgID                                                                              
INNER JOIN invgroupmapmaster IGM1                                                                               
ON IGM1.groupid = IOG1.orggroupid                 
AND IGM1.parent = 'Y'                                                                                                                          
AND IGM1.investigationid = T.actualgrpid                                                                                                                      
                                                            
DECLARE @tblTempOrdInvExploded TABLE                                                                                      
(                                   
rowid                   INT,                                                                                                                          
accessionno             VARCHAR(10),                                                            
actualgrpid             BIGINT,                           
grpid                   VARCHAR(10),                                
firstlvlseq             INT,                                              
grpcontentseq           INT,                                                    
innercontentseq         INT,                                                                                                                          
invid                   BIGINT,                                                                                                                          
parentgrpid    BIGINT,                                                                                                                          
rootgroupid             VARCHAR(10),                       
deptname           VARCHAR(255),                              
valuesgrpid             BIGINT,                                                                                                                          
groupname               VARCHAR(max),                                                                   
investigationvalueid    BIGINT,                                                           
name                    VARCHAR(max),                                                                                                                          
value                   VARCHAR(max),                                                                           
sequenceno              INT,                                                                                                                
methodname           VARCHAR(500),                                     
notes                VARCHAR(max),                                                                                                                          
referencerange          VARCHAR(max),                                                 
           PrintableRange          VARCHAR(max),        
sampleid                BIGINT,                                                           
samplename              VARCHAR(500),                                         
comments                VARCHAR(max),                                                                                                                          
units     VARCHAR(100),                                                                                               
patternid               BIGINT,                                                                                                                
patternname             VARCHAR(200),                                                                     
deptid        BIGINT,                                                                                                                          
validationtext          VARCHAR(max),                                           
isabnormal              VARCHAR(50),                                  
invvalidationtext       VARCHAR(max),                                                                                                                          
[groupcomment]          [VARCHAR](255),                                                                                                                         
[groupmedicalremarks]   [VARCHAR](255),                                                                                                      
resultvaluetype         NVARCHAR(200),                                                                                                               
decimalplaces INT,                   
pkgid                   INT,                                                                                                                     
packagename             VARCHAR(255),                                                                                                             
rootgrpname VARCHAR(250),                      
result                  VARCHAR(max),                 
medicalremarks          NVARCHAR(max),                               
parentgrpname           VARCHAR(250),                                                                                                     
isnonreportable         CHAR(1),                                                
childprintseparately    CHAR(1),                                                                                                                      
approvedby              BIGINT,                                                                                                                          
approvername            NVARCHAR(500),                                                                      
approverqualification   NVARCHAR(500),                                                                                                                      
childpagenumber         INT,                                                                                                      
parentprintseparately   CHAR(1),     
parentpagenumber        INT,                                                                                                  
isgroup                CHAR(1),                                                                                                                          
authorizedby            BIGINT,              
authorizername          NVARCHAR(500),                                                                                           
authorizerqualification NVARCHAR(500),                                                                                                                          
deptprintseparately     CHAR(1),                           
deptpagenumber          INT,                                                                                                            
patientvisiid           BIGINT,                                                                                              
isrejected              CHAR(1),                                                                                                                          
iswithheld              CHAR(1),                                                             
newvalue   NVARCHAR(20),                                                       
convreferencerange      VARCHAR(max),                                                                
convvalue               VARCHAR(max),                                                                                                                      
uid                     VARCHAR(255),                                                                          
ConvUOMCode             varchar(50),                                                                        
OtherLanguage NVarchar(200)NULL,             
OtherLanguageHeader NVarchar(200)NULL                                                                        
)    
    
DECLARE @tblTempOrdInvExploded2 TABLE    
(                                                         
deptseq                   INT,     
l2contentseq     INT,                                                                                                                         
accessionno             VARCHAR(10),                                                            
actualgrpid             BIGINT,                           
grpid                   VARCHAR(10),                                
firstlvlseq             INT,                                                                            
grpcontentseq           INT,                                                    
innercontentseq         INT,                                                                                                                          
invid                   BIGINT,                               
parentgrpid    BIGINT,                                                                      
rootgroupid             VARCHAR(10),                       
deptname           VARCHAR(255),                              
valuesgrpid             BIGINT,                                                                                                                          
groupname               VARCHAR(max),                                                                   
investigationvalueid    BIGINT,                                                           
name                    VARCHAR(max),                                                                                                                          
value                   VARCHAR(max),                                                                           
sequenceno              INT,                                                                                                                
methodname           VARCHAR(500),                                     
notes                VARCHAR(max),                                                                            
referencerange          VARCHAR(max),                                                 
           PrintableRange          VARCHAR(max),        
sampleid                BIGINT,                                                           
samplename              VARCHAR(500),                                         
comments       VARCHAR(max),                                                                                                                          
units     VARCHAR(100),                                                                                                                          
patternid               BIGINT,                                                                                                                
patternname             VARCHAR(200),                                                                     
deptid        BIGINT,                                                                                                                          
validationtext          VARCHAR(max),                                           
isabnormal              VARCHAR(50),                                  
invvalidationtext       VARCHAR(max),                                                                                                                          
[groupcomment]          [VARCHAR](255),                                                                                                                         
[groupmedicalremarks]   [VARCHAR](255),                                                                                                      
resultvaluetype         NVARCHAR(200),                                                                                                               
decimalplaces INT,                                                                                                                          
pkgid                   INT,                                                                                                                     
packagename             VARCHAR(255),                                                                                                             
rootgrpname VARCHAR(250),                      
result                  VARCHAR(max),                 
medicalremarks          NVARCHAR(max),                               
parentgrpname           VARCHAR(250),                                                                                                     
isnonreportable         CHAR(1),                                                
childprintseparately    CHAR(1),                                                                                                                      
approvedby              BIGINT,                                                                                                                          
approvername            NVARCHAR(500),                                                                      
approverqualification   NVARCHAR(500),                                                                                                                      
childpagenumber         INT,                                                                                                      
parentprintseparately   CHAR(1),                                                                                                                          
parentpagenumber        INT,                                                                                                  
isgroup                CHAR(1),                                                                                                                          
authorizedby            BIGINT,                                                                                                               
authorizername          NVARCHAR(500),                                                                                           
authorizerqualification NVARCHAR(500),                                                                                                                          
deptprintseparately     CHAR(1),                           
deptpagenumber          INT,       
patientvisiid           BIGINT,                                                                                              
isrejected              CHAR(1),                                                                                                                          
iswithheld              CHAR(1),                                                               
newvalue   NVARCHAR(20),                                                       
convreferencerange      VARCHAR(max),                                                                
convvalue               VARCHAR(max),       
uid                     VARCHAR(255),                                                                          
ConvUOMCode             varchar(50),                                                                        
OtherLanguage NVarchar(200)NULL,             
OtherLanguageHeader NVarchar(200)NULL                                                                        
)                                                                                                                         
    
DECLARE @tblTempOrdInvExplodedResult TABLE                                                                                                                          
(                                                                                                                          
temprowid         BIGINT IDENTITY(1, 1),                                                              
rowid                   INT,                                                                                                          
accessionno             VARCHAR(10),                                                                                                                          
actualgrpid           INT,             
grpid                   VARCHAR(10),                                                                                                                
firstlvlseq    INT,                                                                                                                          
grpcontentseq           INT,                                                                                                                         
innercontentseq  INT,                                           
invid                   BIGINT,                
parentgrpid             BIGINT,                                                                                                
rootgroupid             VARCHAR(10),                                                                                                                          
deptname                VARCHAR(255),                                                                                           
valuesgrpid             BIGINT,                                                                                                                          
groupname               VARCHAR(max),                                                       
investigationvalueid    BIGINT,                                                                                          
name                    VARCHAR(max),                    
value                   VARCHAR(max),                                                                                                                          
sequenceno              INT,                                                                                                                          
methodname          VARCHAR(500),          
notes                   VARCHAR(max),                                                                            
referencerange          VARCHAR(max),                                                                                                                          
         PrintableRange         VARCHAR(max),        
sampleid  BIGINT,                                                                                                                          
samplename              VARCHAR(500),                                   
technicalremarks        NVARCHAR(max),                
units                   VARCHAR(100),                                                           
patternid               BIGINT,                                                                                                  
patternname           VARCHAR(200),                                                                                                                          
deptid                  BIGINT,                                                                                                          
validationtext          VARCHAR(max),                                            
isabnormal VARCHAR(50),                                                                                                                          
invvalidationtext       VARCHAR(max),                                                                                      
[medicalremarks]        [NVARCHAR](max),                                                                                                        
resultvaluetype         NVARCHAR(200),                                                                     
decimalplaces           INT,                                                                                                                          
pkgid                   INT,                                                                                                                          
packagename             VARCHAR(255),                                                                                             
rootgrpname             VARCHAR(250),                                                                                   
result   VARCHAR(max),                                                                                                   
attgroupid              BIGINT,                                                                                                  
parentgrpname           VARCHAR(250),                                                                                                                          
isnonreportable         CHAR(1),                                                              
childprintseparately    CHAR(1),                                                                                                                          
approvedby          BIGINT,                                                                                                                          
approvername NVARCHAR(500),                                                                                    
approverqualification   NVARCHAR(500),                                                                                                                          
childpagenumber         INT,                                                                  
parentprintseparately   CHAR(1),                                                                    
parentpagenumber    INT,                                                                                                                          
isgroup        CHAR(1),                                                                                                                          
authorizedby            BIGINT,                                     
authorizername          NVARCHAR(500),                                                 
authorizerqualification NVARCHAR(500),                                                                                                                          
deptprintseparately     CHAR(1),                                
deptpagenumber          INT,                                                                                                         
patientvisitid          BIGINT,                                                                                                    
isrejected              CHAR(1),                                                   
iswithheld              CHAR(1),      
newvalue                NVARCHAR(20),                                                                                                                          
convreferencerange      VARCHAR(max),                                                                                                                          
convvalue              VARCHAR(max),                                                                               
uid                     VARCHAR(255),                                                             
ConvUOMCode   varchar(50)  ,                                                                                         
[GroupMedicalRemarks]   [VARCHAR](255) ,                                                                        
OtherLanguage NVarchar(200),                                                                        
OtherLanguageHeader NVarchar(200)NULL,                    
AbnormalFlagSymbol NVarchar(200),                  
ConvAbnormalFlagSymbol NVarchar(200)                                                               
)                                                                                                                          
DECLARE @tblTempOrdInvExplodedResultOrderbyRowID TABLE                                                      
(         
temorowid               BIGINT,                                                                                                              
rowid               INT,                                                                                                            
accessionno             VARCHAR(10),                                                                                   
actualgrpid             INT,                                                                   
grpid                   VARCHAR(10),                                                                     
firstlvlseq             INT,                                                                                
grpcontentseq           INT,                                                                                                                          
innercontentseq INT,                                                                                                                          
invid                   BIGINT,                                                                                                                          
parentgrpid             BIGINT,                             
rootgroupid             VARCHAR(10),               
deptname                VARCHAR(255),                                          
valuesgrpid             BIGINT,                                                                          
groupname               VARCHAR(max),                                                                                                                          
investigationvalueid    BIGINT,                                                                      
name                    VARCHAR(max),                                                                                                                          
value            VARCHAR(max),                          
sequenceno        INT,                                                                                                                          
methodname              VARCHAR(500),                                            
notes                   VARCHAR(max),         
referencerange          VARCHAR(max),               
     PrintableRange         VARCHAR(max),        
           sampleid                BIGINT,        
samplename              VARCHAR(500),                                                                                                                          
technicalremarks    NVARCHAR(max),                                                                                     
units                   VARCHAR(100),                                                                                    
patternid               BIGINT,                                                                                                                          
patternname             VARCHAR(200),                                  
deptid       BIGINT,                         
validationtext   VARCHAR(max),                                                                                                                          
isabnormal              VARCHAR(50),                                                                                                                          
invvalidationtext       VARCHAR(max),                                                                                                                          
[medicalremarks]        [NVARCHAR](max),                                                                                                                  
resultvaluetype         NVARCHAR(200),                                                         
decimalplaces INT,                
pkgid INT,                                                                                                                         
packagename             VARCHAR(255),                                                                                                                          
rootgrpname             VARCHAR(250),                                             
result                  VARCHAR(max),                                                                                                                   
attgroupid              BIGINT,                                                                                 
                                           
parentgrpname           VARCHAR(250),                                                              
isnonreportable         CHAR(1),                                                                                                                          
childprintseparately    CHAR(1),                                                       
approvedby              BIGINT,                                                                                                   
approvername            NVARCHAR(500),                                                                                    
approverqualification   NVARCHAR(500),                                                                                                               
childpagenumber         INT,                                                                                  
parentprintseparately   CHAR(1),                                                                                                   
parentpagenumber        INT,                                                                                                                          
isgroup                 CHAR(1),                                                                            
authorizedby            BIGINT,                                                              
authorizername          NVARCHAR(500),                                                                                                                     
authorizerqualification NVARCHAR(500),                                                                                                                          
deptprintseparately     CHAR(1),                      
deptpagenumber    INT,                                               
patientvisiid           BIGINT,                                                                                                                          
isrejected              CHAR(1),                                                       
iswithheld              CHAR(1),                                                                                                                       
retestrecheck           NVARCHAR(20),                                                                                                                        
convreferencerange      VARCHAR(max),                                                                            
convvalue               VARCHAR(max),                                                                                                                          
uid                     VARCHAR(255),                                                                          
ConvUOMCode   varchar(50),                                                                        
[GroupMedicalRemarks]   [VARCHAR](255),                                                                        
OtherLanguage  NVarchar(200)NULL,                                                                     
OtherLanguageHeader NVarchar(200)NULL,                    
AbnormalFlagsymbol     NVARCHAR(max),                  
ConvAbnormalFlagSymbol NVarchar(200)                                          
)                                                                                  
                                                                              
/*Venkat added this code*/                                                                          
--select TINExploded.DeptID,TINExploded.DeptName,ISNULL(iom.HeaderID,0),ISNULL(HeaderName,'') from @tblOrdInvExploded TINExploded                                                                                                                             



  
    
    
    
      
       
       
      
--inner join InvestigationOrgMapping IOM on iom.InvestigationID = TINExploded.InvID                                                                                                
--left join InvestigationHeader IH on IH.HeaderID = iom.HeaderID                                                                        
--and iom.OrgID = @OrgID                                                                                                                    
                                                                                                                      
UPDATE @tblOrdInvExploded                      
SET  deptid = IH.headerid,                                                                                                                        
deptname = '<B><font size=3>' + ih.headername                                                                      
+ '</font></B>'                                                                                    
,deptseq = ih.sequenceno,                                                                        
OtherLanguageHeader='<B><font size=3>'+IH.OtherLanguageHeader +'</font></B>'                                                                        
FROM   @tblOrdInvExploded TINExploded                                                           
--select TINExploded.DeptID,TINExploded.DeptName,ISNULL(iom.HeaderID,0),ISNULL(HeaderName,'') from @tblOrdInvExploded TINExploded                      
INNER JOIN investigationorgmapping IOM                                                                                                                 
ON iom.investigationid = TINExploded.invid                                                                                                                        
LEFT JOIN investigationheader IH                
ON IH.headerid = iom.headerid                                                                                                                        
AND iom.orgid = @OrgID                                                                                                     
                                                                                                              
                                                                                                              
                                              
INSERT INTO @tblTempOrdInvExploded2    
(                    
deptseq,           
l2contentseq,                                                         
accessionno,                                                                                                                          
actualgrpid,                                                            
grpid,                                                                                                                 
firstlvlseq,                                                                                                                          
grpcontentseq,                                                                                                                          
innercontentseq,                                                                                                            
invid,                                               
parentgrpid,                                 
rootgroupid,                                                  
deptname,                                   
valuesgrpid,                                                                 
groupname,                                                                                                    
investigationvalueid,                                                                     
name,                       
value,                                                                                                                          
sequenceno,                                                                                                                          
methodname,                                                       
notes,                                                  
referencerange,                                                              
                   PrintableRange,        
sampleid,                                                                              
samplename,                                                                                                                          
comments,                                                                                                                          
units,                                                                                                              
patternid,                                                                                                                         
patternname,                                                                                                                          
deptid,                                                                                                                          
validationtext,                                                                                                                          
isabnormal,             
invvalidationtext,                                                                                                                          
groupcomment,                                             
groupmedicalremarks,        
resultvaluetype,                                                                         
decimalplaces,                                             
pkgid,                                                            packagename,                                                                                      
rootgrpname,                                                                                                        
result,                                                                                                                   
medicalremarks,                                                      
parentgrpname,                                                                                                                          
isnonreportable,                                                                                                                          
childprintseparately,                                                                                                                          
approvedby,                                                                                                                          
parentprintseparately,                                                                                                
isgroup,                                                                                                                          
authorizedby,                                                                                                                          
patientvisiid,                                  
isrejected,                          
iswithheld,                                                                                
newvalue,                                                                                     
convreferencerange,                                                               
convvalue,                                                                    
uid,                                                                          
ConvUOMCode,                                                                        
OtherLanguage,                                     
OtherLanguageHeader)                                                                                          
SELECT     
distinct deptseq,l2contentseq,tbl.accessionno,                                                                        
CASE                                                                                                                          
WHEN Isnull(PIV.packageid, 0) > 0 THEN PIV.groupid                                                               
ELSE tbl.actualgrpid                                                                            
END,                                                                             
PIV.groupid,                                                                                                                          
tbl.firstlvlseq,                                                                                                     
tbl.grpcontentseq,                                                                                          
tbl.innercontentseq,                     
tbl.invid,                                                      
tbl.parentgrpid,                                                                                                                          
tbl.rootgroupid,                                                                                                                  
tbl.deptname,                                                 
PIV.groupid AS ValuesGRpID,                                                                                                                  
PIV.groupname,                                                                                                                          
0,                                                                            
CASE               
WHEN tbl.isrejected = 'Y' THEN '* ' + PIV.investigationname                                                           
WHEN tbl.iswithheld = 'Y' THEN '* ' + PIV.investigationname                                           
ELSE PIV.investigationname                                                                                                                          
END,                                                                                                        
'',                                                                                                                          
0,                                                                                        
tbl.methodname,                                                                                                                          
tbl.notes,                                                                               
tbl.referencerange,                                                           
             tbl.PrintableRange,        
tbl.sampleid,                             
tbl.samplename,                                                                                 
tbl.comments,                                                                                                                          
tbl.uomcode,                                                                          
patternid,                                                                                                                          
patternname,                                                                        
deptid,                                                                                                                          
tbl.validationtext,                                                                     PIV.isabnormal,                                              
tbl.invvalidationtext,                                                                                     
PIV.groupcomment,                                                                                                                          
PIV.groupmedicalremarks,     
tbl.resultvaluetype,                                                                                                                       
tbl.decimalplaces,                                                                                                                          
tbl.pkgid,                                                                                                                          
tbl.packagename,                                                                                                                          
tbl.rootgrpname,                                                                                                                          
tbl.result,                                                                                      
tbl.medicalremarks,                 
tbl.parentgrpname,                                                                    
PIV.isnonreportable,                                          
tbl.childprintseparately,                                                                                                                          
PIV.approvedby,                                                                                                                          
tbl.parentprintseparately,                                                                                                                          
tbl.isgroup,                                                                   
PIV.authorizedby,                         
tbl.patientvisitid,                                                              
tbl.isrejected,                                                                                                                    
tbl.iswithheld,                                                                     
tbl.newvalue,                                                                                                                          
tbl.convreferencerange,                                                                                                                          
tbl.convresult,                                                                                                                   
PIV.uid,                                                                          
tbl.ConvUOMCode ,                                                                        
'' ,                                                                        
tbl.OtherLanguageHeader                                                                        
FROM   @tblOrdInvExploded tbl                                                   
INNER JOIN @tblPatientInvestigation PIV                                                                                                            
ON PIV.investigationid = tbl.invid                                                                        
AND ( PIV.groupid = tbl.actualgrpid                                 
OR PIV.groupid = tbl.grpid )                                                                                                                          
AND PIV.packageid = tbl.pkgid                                                                                                                    
AND PIV.patientvisitid = tbl.patientvisitid                                                                                                   
AND PIV.uid = tbl.uid                                                                                                                         
INNER JOIN @tblInvestigationValues IV                                                       
ON IV.investigationid = PIV.investigationid                                                                                                                          
AND IV.groupid = PIV.groupid                                   
AND Isnull(IV.packageid,0) = Isnull(PIV.packageid,0)                                                                             
AND IV.uid = PIV.uid                                                                                                                          
/*    
ORDER  BY deptseq,                                               
firstlvlseq,                                                                                        
grpcontentseq,                                                                           
innercontentseq,             
l2contentseq                                                                                                                          
*/    
    
INSERT INTO @tblTempOrdInvExploded                                                                                        
(rowid,                                                                                                            
accessionno,                                                                                                                          
actualgrpid,                                                            
grpid,                                                                                                                 
firstlvlseq,                                                                                                                          
grpcontentseq,                                                                       
innercontentseq,                                                                                                            
invid,                                               
parentgrpid,                                 
rootgroupid,                                                  
deptname,                                   
valuesgrpid,                                                                 
groupname,                                                                                                    
investigationvalueid,                                                                                                                          
name,                       
value,                                                                                                                          
sequenceno,                                                                                                                          
methodname,                                                                                                                          
notes,                                                           
referencerange,                                                              
PrintableRange,        
sampleid,                                                                              
samplename,                                                                                                                          
comments,                                                                                                                          
units,                                                                                                              
patternid,                                                                                                                         
patternname,                                                                                                                          
deptid,               
validationtext,                                                                                                                          
isabnormal,                                                                                                                          
invvalidationtext,                                                                
groupcomment,                                             
groupmedicalremarks,        
resultvaluetype,                                                                         
decimalplaces,                                                                                                                          
pkgid,    
packagename,                                                                                                          
rootgrpname,                                                                                                        
result,                                                                                                                   
medicalremarks,                                                      
parentgrpname,                                                                                                                          
isnonreportable,                                                                                                                          
childprintseparately,                                                                                                                          
approvedby,                                                                                                                          
parentprintseparately,                                                                                                
isgroup,                                              
authorizedby,                                                                                                                          
patientvisiid,                                  
isrejected,                          
iswithheld,                                                                                
newvalue,                                                 
convreferencerange,                                                               
convvalue,                                                                                                               
uid,                                                                          
ConvUOMCode,                                                                        
OtherLanguage,                                     
OtherLanguageHeader)                                                                                          
SELECT Row_number()                                                                                                                          
OVER ( ORDER BY deptseq, firstlvlseq, grpcontentseq, innercontentseq,l2contentseq),                                                                                                                          
accessionno,                                                                                                                          
actualgrpid,                                                            
grpid,                                                                                                                 
firstlvlseq,                                                                                                                          
grpcontentseq,                                                                                                                          
innercontentseq,                                                                                                            
invid,                                               
parentgrpid,                           
rootgroupid,                                                  
deptname,                                   
valuesgrpid,                                                                 
groupname,                                 
investigationvalueid,                                                                                                                          
name,                       
value,                                                              
sequenceno,                                                                                                                          
methodname,                                                                                                                          
notes,                                                           
referencerange,                                                              
PrintableRange,        
sampleid,                                                                              
samplename,                                                                                                                          
comments,                                                                                                                          
units,                                                                                                              
patternid,                                                                                                                         
patternname,                                                                                                                          
deptid,                                                                                                                          
validationtext,                                                                          
isabnormal,                                                                                  
invvalidationtext,                                                                                                                          
groupcomment,                                             
groupmedicalremarks,        
resultvaluetype,                                                                 
decimalplaces,                                                                                                                          
pkgid,    
packagename,                                                                                                          
rootgrpname,                                                                                                        
result,                                                                                                                   
medicalremarks,                                                      
parentgrpname,                                                                                                                          
isnonreportable,                                                                                                                          
childprintseparately,                                                                                                                          
approvedby,                                                                                                                          
parentprintseparately,                                                                                                
isgroup,                                                                                                                          
authorizedby,                                                                                                                          
patientvisiid,                                  
isrejected,                 
iswithheld,                                                                                
newvalue,                                                                                     
convreferencerange,                          
convvalue,                                                                                                               
uid,                                                                          
ConvUOMCode,                                                                        
OtherLanguage,                                     
OtherLanguageHeader    
FROM   @tblTempOrdInvExploded2 tbl                                                   
ORDER  BY deptseq,                                               
firstlvlseq,                                                                                        
grpcontentseq,                                                                           
innercontentseq,             
l2contentseq                                                                                                              
    
                                                                                                          
                                  
                                                                                                                      
--select 'temp',* from @tblTempOrdInvExploded                                                                                                             
    
DECLARE @RowID BIGINT                                                                                                                          
                                                                                                                          
INSERT INTO @tblTempOrdInvExplodedResult        
SELECT rowid,                                                                     
accessionno,                                                  
actualgrpid,                                                                                                                       
grpid,                                                                                                                          
firstlvlseq,                           
grpcontentseq,                                                                            
innercontentseq,                                                                                                                    
invid,                                                                                    
parentgrpid,                                                                                                                          
rootgroupid,                                                                                                                          
deptname,                                                                                                                          
valuesgrpid,                                          
groupname,                                                               
investigationvalueid,                                                                                     
name,                                           
value,                                                                                                
sequenceno,                                                                                             
methodname,                                                                                                                          
notes,                                           
referencerange,                                                                                                                          
             PrintableRange,        
sampleid,                                                                           
samplename,                                                            
comments,                                 
units,                                                                                                                          
patternid,                                                                                           
patternname,                                                 
deptid,                                                                               
validationtext,                                                                                                                          
isabnormal,                                                                                                                  
invvalidationtext MedicalRemarks,                                                                                                     
resultvaluetype,                              
decimalplaces,                           
pkgid,                                                                                                                 
packagename,                                                                 
rootgrpname,                                                                                                  
result,                                                                                                                          
medicalremarks,                           
0,                                                                                                                          
parentgrpname,                                                                                                                          
isnonreportable,                                                                                  
childprintseparately,                                                                                                                         
approvedby,                                                                                                                          
approvername,                                                                                                                          
approverqualification,                                                                          
childpagenumber,                                                                                                                          
parentprintseparately,                                                                             
parentpagenumber,                               
isgroup,                                           
authorizedby,                                                                                                                          
authorizername,                                                                                                 
authorizerqualification,                                                                                                          
deptprintseparately,                                                                  
deptpagenumber,                                                                                                                          
patientvisiid,                                                                                                                          
isrejected,                                                                                                    
iswithheld,                                                                                                                          
newvalue,                                                                    
convreferencerange,                                                                   
convvalue,                                                     
uid,                                                                          
ConvUOMCode,              
GroupMedicalRemarks,                                                                        
OtherLanguage,                                                                        
OtherLanguageHeader,'',''                  
FROM   @tblTempOrdInvExploded                                                                                                                          
WHERE  1 = 2           
                                                                                                  
--SELECT * FROM @tblPatientInvestigation                                                                                                                        
--SELECT * FROM @tblTempOrdInvExploded                                                                                                                        
DECLARE rowidcursor CURSOR FOR                                                                           
SELECT rowid                                                                                                                       
FROM  @tblTempOrdInvExploded                                                                                                                   
ORDER  BY rowid                                                                  
                                                                                        
OPEN rowidcursor               
                                                                                                                          
FETCH next FROM rowidcursor INTO @RowID                     
                 
WHILE @@FETCH_STATUS = 0                                                                                                                   
BEGIN                                                         
                                                                                                                 
 INSERT INTO @tblTempOrdInvExplodedResult                                                                                                                    
(rowid,                                                                                                                          
deptname,                                                                                                    
name,                                                                                    
deptid,                                                                                                                          
rootgroupid,                                                        
childprintseparately,                                                                                                   
approvedby,                
parentgrpid,                                                                            
parentprintseparately,        
isgroup,                                                                                           
authorizedby,                                                                                                                          
accessionno,grpid,                                                                        
OtherLanguageHeader)                                     
SELECT rowid,                                                            
deptname,                                                                                                                          
Ltrim(Rtrim(Isnull(deptname, ''))),                                                                             
deptid,                                                                                                                          
Isnull(rootgroupid, invid),                                                                                       
childprintseparately,                     
approvedby,                                                         
parentgrpid,                                                                                                                          
parentprintseparately,                                                       
isgroup,                                                                                                                          
authorizedby,                                                                                  
accessionno,grpid ,                                                                        
OtherLanguageHeader                                                                                                       
FROM   @tblTempOrdInvExploded                                                                                      
WHERE  rowid = @RowID                                                                  
                                      
--INSERT INTO @tblTempOrdInvExplodedResult (RowID, DeptName, Name, DeptID,RootGroupID,ChildPrintSeparately,ApprovedBy,ParentGrpID                                                                                                             
      
      
      
      
        
          
            
              
                
                  
                    
                      
                        
                          
                            
                              
                                
                                  
                                
                                      
                                        
                                          
                                            
                                              
                              
                                                  
                                            
                                                      
                                                        
                                   
--,ParentPrintSeparately,IsGroup,AuthorizedBy,AccessionNo)                                                                                                                          
--SELECT tbl.RowID, DeptName, '' + LTRIM(RTRIM(isNull(IH.HeaderName,''))) + '',tbl.DeptID,ISNULL(RootGroupID,InvID),                               
--ChildPrintSeparately,ApprovedBy,ParentGrpID,ParentPrintSeparately,IsGroup,AuthorizedBy,AccessionNo FROM @tblTempOrdInvExploded tbl                                                                              
--LEFT join InvestigationOrgMapping IOM on  IOM.InvestigationID=tbl.InvID AND IOM.OrgID=@OrgID                                                                                                                                        
--LEFT join InvestigationHeader IH on IH.HeaderID=IOM.HeaderID                                
--WHERE tbl.RowID=@RowID                                                                                                                
-- INSERT INTO @tblTempOrdInvExplodedResult (RowID,RootGrpName, Name, RootGroupID,TechnicalRemarks,MedicalRemarks,DeptID,GrpID,                                                                                                                               



  
    
    
     
      
      
      
      
        
          
            
              
            
                  
                   
                       
                        
                          
                            
                              
                                
                                  
                                   
                                       
                                        
                                                              
      
                                                
                                                  
                                 
                                                  
                                                        
                                                         
                                        
                                                              
                                                               
-- ChildPrintSeparately,ApprovedBy,ParentGrpID,ParentPrintSeparately,IsGroup,AuthorizedBy,AccessionNo)                                               
--SELECT RowID,RootGrpName, '' + LTRIM(RTRIM(isNull(RootGrpName,''))) + '', RootGroupID                                                                                                                                                             
--,GroupComment,GroupMedicalRemarks,DeptID,GrpID,ChildPrintSeparately,ApprovedBy,ParentGrpID,ParentPrintSeparately,IsGroup,AuthorizedBy                                          
--,AccessionNo                                                                                    
--FROM  @tblTempOrdInvExploded  WHERE RowID=@RowID AND isNull(RootGrpName,'NULL') !='NULL'         
--INSERT INTO @tblTempOrdInvExplodedResult (RowID,ParentGrpName, Name, ParentGrpID,TechnicalRemarks,MedicalRemarks,DeptID,GrpID,                                                                                
                                
                                  
                                    
                       
                                        
                                          
                                            
                                              
                                               
                                                   
                                                    
                  
                                                        
--RootGroupID,ChildPrintSeparately,ApprovedBy,ParentPrintSeparately,IsGroup,AuthorizedBy,AccessionNo)                                                                               
                                
                                                              
                                                               
                                                                  
                                                                    
                                                                      
                                                                        
                                                            
                                                                            
                                                                              
                                                                         
                                                                      
--SELECT RowID,ParentGrpName,                                                                                                                     
--Case When ISNULL(RootGrpName,'')<>ParentGrpName Then '' + LTRIM(RTRIM(isNull(ParentGrpName,''))) + ''                                                                  
                                                           
                                                            
                                      
                    
                                                                  
                                                       
                                                                      
                                                                        
                                                                          
                                                                            
                
                                                                             
--Else NULL End,ParentGrpID,GroupComment,GroupMedicalRemarks,DeptID,GrpID,RootGroupID,ChildPrintSeparately,ApprovedBy,                                                                                                                                         



  
    
    
    
     
       
       
       
       
           
            
              
                
                 
                                                
                                                  
                                                   
--ParentPrintSeparately,IsGroup,AuthorizedBy,AccessionNo                                      
--FROM  @tblTempOrdInvExploded  WHERE RowID=@RowID AND isNull(ParentGrpName,'NULL') !='NULL' AND ParentGrpName !=''                                                                                                  
    
      
      
       
       
        
          
            
              
                
                 
                     
                     
                        
--INSERT INTO @tblTempOrdInvExplodedResult (RowID,GroupName, Name, ActualGrpID,TechnicalRemarks,MedicalRemarks,DeptID,GrpID,                                                                                                       
                            
                               
                                
                                  
                                    
              
          
                                      
                                           
                                               
                                                
                                                  
                                       
                                                      
                                      
                               
--RootGroupID,ChildPrintSeparately,ApprovedBy,ParentGrpID,ParentPrintSeparately,IsGroup,AuthorizedBy,AccessionNo)                                                                                                                 
--SELECT RowID,GroupName,                                                                  
--Case When ISNULL(RootGrpName,'')<>GroupName AND  ISNULL(ParentGrpName,'')<>GroupName Then                                                                                                                             
--'' + LTRIM(RTRIM(isNull(GroupName,''))) + '' Else NULL End,                                                                                                                                                             
--ActualGrpID,GroupComment,GroupMedicalRemarks,DeptID,GrpID,RootGroupID,ChildPrintSeparately,ApprovedBy,ParentGrpID,                                          
--ParentPrintSeparately,IsGroup,AuthorizedBy,AccessionNo                                                                                                                            
--FROM  @tblTempOrdInvExploded  WHERE RowID=@RowID AND isNull(GroupName,'NULL') !='NULL' AND GroupName !=''                              
INSERT INTO @tblTempOrdInvExplodedResult                                                                                                                          
(rowid,                                                                                                 
accessionno,                                                                                                           
actualgrpid,                                                                                         
grpid,                 
firstlvlseq,                                                                                                                          
grpcontentseq,                                          
innercontentseq,                                               
invid,                                                                                                                          
parentgrpid,                             
rootgroupid,                                                  
deptname,                                                                   
valuesgrpid,                          groupname,                                                                                                                          
investigationvalueid,                                                                                                                          
name,                                                                             
value,                                  
sequenceno,                         
sampleid,                                                                                                                          
samplename,                                          
technicalremarks,                                                                                                         
units,                                                                                                                          
methodname,                                                                                                                          
notes,                                  
referencerange,                                                                                   
                         PrintableRange,        
patternid,                                                                        
patternname,                                                                                                         
deptid,                                                                                                                          
validationtext,                                                                                        
isabnormal,                                                                                                     
invvalidationtext,                                                                                                                    
medicalremarks,                                                                                                                          
resultvaluetype,                                                                
decimalplaces,                                                                                                                          
pkgid,                                                                                        
packagename,                                                                                    
rootgrpname,                                                                                                                          
result,                                                                                                             
parentgrpname,                                                                                              
isnonreportable,                                                                                                                
childprintseparately,                                             
approvedby,                                                                                                              
parentprintseparately,                         
isgroup,                                         
authorizedby,                                                                                                                          
patientvisitid,                                        
isrejected,                                                              
iswithheld,                                                                    
newvalue,                                                                                                                          
convreferencerange,                                            
convvalue,                                                                                                                          
uid,                                                                        
ConvUOMCode,GroupMedicalRemarks,OtherLanguage,OtherLanguageHeader)                                                            
SELECT rowid,                                                                                                                   
accessionno,                                                                                                                          
actualgrpid,                                                             
grpid,                                                                     
firstlvlseq,                                                                                                                          
grpcontentseq,                                                                                        
innercontentseq,                                                                                        
invid,                                                               
parentgrpid,                                                          
rootgroupid,                                                                                                                          
Isnull(deptname, ''),                                                                                                                          
valuesgrpid,                                                                                                                          
Isnull(groupname, ''),                           
investigationvalueid,                                                                                                                          
name,                                                                                                                          
value,                                                                                                                    
sequenceno,                                                                                                                          
sampleid,                                                                                                               
samplename,                                                                                                               
comments,                                                                                                         
units,                                              
methodname,                                                                                                                          
notes,                                                                                                                          
referencerange,                                                                                                                       
                   PrintableRange,        
patternid,                                                                                                                     
patternname,                                                                                                                          
deptid,                                                                                                                         
validationtext,                      
isabnormal,                                                                                    
invvalidationtext,                                                                                                            
medicalremarks,                                                                                                                          
resultvaluetype,              
decimalplaces,                                           
pkgid,                                                                                                                          
packagename,                                                                                                                          
rootgrpname,                                                   
result,                                                                                               
parentgrpname,                                                                                                                          
isnonreportable,                                                                                                           
childprintseparately,                                                                                                                          
approvedby,                                                                                         
parentprintseparately,                                        
isgroup,                                              
authorizedby,        
patientvisiid,                                                                                                               
isrejected,                                                                                                                          
iswithheld,                                                                                                                          
newvalue,                                                                   
convreferencerange,                                                       
convvalue,                                                                                   
uid,                                                                          
ConvUOMCode,GroupMedicalRemarks ,OtherLanguage,OtherLanguageHeader                                                                                    
FROM   @tblTempOrdInvExploded                                                                                                                          
WHERE  rowid = @RowID                                                                                    
ORDER  BY rowid                                                         
                                                        
FETCH next FROM rowidcursor INTO @RowID                                                                             
END                                                                                                                          
                                         
CLOSE rowidcursor                                                                                
                                                                                           
DEALLOCATE rowidcursor                                                        
                                                            
                                                            
DELETE FROM tmp1                                                                                                                          
FROM @tblTempOrdInvExplodedResult tmp1                                                                                                  
LEFT JOIN (SELECT Min(temprowid) AS id,                                  
invid,                                      
accessionno                                                                                    
FROM   @tblTempOrdInvExplodedResult                                
WHERE accessionno IS NOT NULL                                                                                   
AND invid IS NOT NULL                                                                                                                          
GROUP  BY invid,                  
accessionno,                                                                            
parentgrpid) tmp2       
ON tmp1.invid = tmp2.invid                                                                                                                          
AND tmp1.accessionno = tmp2.accessionno                                                                                      
AND tmp1.temprowid = tmp2.id                                                                                                                  
WHERE  tmp2.id IS NULL                                                                                                                
AND tmp1.accessionno IS NOT NULL                                         
AND tmp1.invid IS NOT NULL                                                                               
                                                         
INSERT INTO @tblTempOrdInvExplodedResultOrderbyRowID                                                 
SELECT *                                                                         
FROM   @tblTempOrdInvExplodedResult                                                                  
ORDER  BY temprowid                                                                                                                          
                                                                                         
--select * from @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                                        
                                                            
DECLARE @tblUnqDept TABLE                                                                                             
(                                                                                   
rowid    BIGINT,                                                                                                                          
deptname VARCHAR(max)                                                                 
--,                                                                          
--OtherLanguageHeader nvarchar(max)                                                                                    
)                                                         
                                                                                                            
INSERT INTO @tblUnqDept                                                                                       
SELECT Min(rowid),                                                                                                              deptname                                        
    
    
--,                                                                          
--OtherLanguageHeader                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID t                                                                                                                          
WHERE  rowid = (SELECT Min(rowid)                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID t1                                                                  
WHERE  t.deptname = t1.deptname)                   
GROUP BY deptname                                                                                    
--,OtherLanguageHeader                   
 DELETE FROM @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                     
WHERE  deptname IN (SELECT deptname                                                                                                            
FROM   @tblUnqDept)             
AND rowid NOT IN (SELECT rowid                                                                                                                          
FROM   @tblUnqDept)                                                                                                                          
AND ( grpid IS NULL                                         
OR invid IS NULL )                                                                                                                          
                                     
DECLARE @tblRootGrp TABLE                                                                                                                          
(                                                                                                                 
             
rowid  BIGINT,                                                                                                                          
rootgrpname VARCHAR(max)                                                                                                                          
)                            
                                                                                 
INSERT INTO @tblRootGrp                                                                    
SELECT Min(rowid),                                                                                                                          
rootgrpname                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID t                                                                                                           
WHERE  rowid = (SELECT Min(rowid)                                                                                                                  
FROM   @tblTempOrdInvExplodedResultOrderbyRowID t1                                                                                                                          
WHERE  t.rootgrpname = t1.rootgrpname)                                                                                           
GROUP  BY rootgrpname                                                                                                                          
                                                              
DELETE FROM @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                          
WHERE  rootgrpname IN (SELECT rootgrpname                                                                                                              
FROM   @tblRootGrp)                           
AND rowid NOT IN (SELECT rowid                                        
FROM   @tblRootGrp)                                                             
AND ( grpid IS NULL                                                                                                                          
OR invid IS NULL )                                                                                                                          
                                                                                                                          
DECLARE @tblParentGrp TABLE  
(             
rowid         BIGINT,                                                                                                                   
parentgrpname VARCHAR(max)              
)                                               
                                                                      
INSERT INTO @tblParentGrp                   
SELECT Min(rowid),                                                                                
parentgrpname                                             
FROM   @tblTempOrdInvExplodedResultOrderbyRowID t                                                                                                                          
WHERE  rowid = (SELECT Min(rowid)                                                                                                    
FROM   @tblTempOrdInvExplodedResultOrderbyRowID t1                                                                                                                          
WHERE  t.parentgrpname = t1.parentgrpname)                                                                                                                
GROUP  BY parentgrpname                                                                                                         
                                                                                            
DELETE FROM @tblTempOrdInvExplodedResultOrderbyRowID                                                                                         
WHERE  parentgrpname IN (SELECT parentgrpname                           
FROM   @tblParentGrp)                                                                                                                         
AND rowid NOT IN (SELECT rowid                                                    
FROM   @tblParentGrp)                                                                                                                          
AND ( grpid IS NULL                                                                                                                          
OR invid IS NULL )                                                                                                                          
   
DECLARE @tblUnqGrp TABLE                                                                                                    
(                                                                                                                          
rowid         BIGINT,                                                                    
parentgrpname VARCHAR(max),                                                                                                                          
grpname VARCHAR(max)                                              
)                                                                                   
                                                                                                                          
INSERT INTO @tblUnqGrp                                                  
SELECT Min(rowid),                                      
parentgrpname,                                                                                                                          
groupname                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID t                                                                                                                          
WHERE  rowid = (SELECT Min(rowid)                                       
FROM   @tblTempOrdInvExplodedResultOrderbyRowID t1                                                 
WHERE  t.groupname = t1.groupname                                                                  
AND t.parentgrpname = t1.parentgrpname)                                                                                                              
GROUP  BY parentgrpname,                                       
groupname                                                                                                    
                               
DELETE FROM @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                          
WHERE  groupname IN (SELECT groupname                                                                                                                          
FROM   @tblUnqGrp)                                                     
AND rowid NOT IN (SELECT rowid                                                     
FROM   @tblUnqGrp)                                                     
AND ( grpid IS NULL                                                                                
OR invid IS NULL )              
                                                            
DELETE FROM @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                          
WHERE  Isnull(name, 'NULL') = 'NULL'                         
                                
/***CODE Added For Show Method Name And Sample Name in Group Level***/                                                              
IF EXISTS(SELECT COM.configkeyid                                                                                                                          
FROM   configorgmaster COM                                                                        
INNER JOIN configkeymaster CKM                                                                                                                          
ON CKM.configkeyid = COM.configkeyid                                                                                                                          
WHERE  CKM.configkey = 'GroupTestSeperator'                                                                                                                          
AND COM.orgid = @OrgID)                                           
BEGIN                                                                                                                          
DECLARE @SampleCountTable AS TABLE                                        
(                                                                                                                 
countvalue INT                                                                                                                          
)                                       
DECLARE @MethodCountTable AS TABLE                                                                                                                          
(                                      
countvalue INT                                                                                       
)                                                                             
DECLARE @SampleName NVARCHAR(500)                                                                                                                    
DECLARE @MethodName NVARCHAR(500)                                                                                                      
                                                                                                                          
UPDATE tt1                                                      
SET    tt1.attgroupid = IOG.attgroupid                                   
FROM   @tblTempOrdInvExplodedResultOrderbyRowID TT1                                                                                             
INNER JOIN invorggroup IOG                                                                                    
ON IOG.orggroupid = TT1.actualgrpid                                                                                                
WHERE  orgid = @OrgID                                                                                                       
                                                                                                                    
UPDATE @tblTempOrdInvExplodedResultOrderbyRowID                                                                               
SET    methodname = Isnull(methodname, ''),                                                                                                                          
samplename = Isnull(samplename, '')                                                                                                                
                                                                                                              
DECLARE @GrpID BIGINT                                        
DECLARE rowidcursor CURSOR FOR                                                                                
SELECT grpid                                
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                         
WHERE  Isnull(grpid, '0') <> '0'                                                
GROUP  BY grpid                                            
ORDER  BY grpid                                                                                                                          
                                                                                                                          
OPEN rowidcursor                                                                                                                          
                                                                                                                     
FETCH next FROM rowidcursor INTO @GrpID                                                                                
                                                                                                                          
WHILE @@FETCH_STATUS = 0                       
BEGIN                                                                                                                          
--select @GrpID                             
--SELECT * FROM @tblTempOrdInvExplodedResultOrderbyRowID where GrpID= @GrpID and ISNULL(InvID,'')<>''                                                                                                                                                         



  
    
    
    
      
      
      
      
        
          
            
              
                
                  
                    
                      
                        
INSERT INTO @SampleCountTable                                                                                                                          
SELECT Count(DISTINCT( samplename ))                                            
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                 
WHERE  grpid = @GrpID                                                                                                                          
AND Isnull(invid, '') <> ''                                                                                                
GROUP  BY samplename                                                                                                                  
                                                                        
INSERT INTO @MethodCountTable                                                                          
SELECT Count(DISTINCT( methodname ))                                                                      
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                       
WHERE  grpid = @GrpID                                                      
AND Isnull(invid, '') <> ''                                                                                                                          
GROUP  BY methodname                                                                                               
                                                                                                                          
--select * from @SampleCountTable                                                                                                                                                                                                                        
--select * from @MethodCountTable                                                                                                                     
IF ( (SELECT Count(1)                                                                                  
FROM   @SampleCountTable) = 1                                                                       
AND (SELECT Count(1)                                                   
FROM   @MethodCountTable) = 1 )                                                                                                                          
BEGIN                                                                                                                          
SELECT @SampleName = samplename                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                      
WHERE  grpid = @GrpID                                                                      
AND Isnull(invid, '') <> ''                                                                                    
GROUP  BY samplename                                                                                 
                                                                                                                    
--UPDATE T SET T.SampleName=@SampleName FROM @tblTempOrdInvExplodedResultOrderbyRowID T where T.GrpID= @GrpID and ISNULL(InvID,'')=''                               
                                                                                     
--Update Unique Sample Name as null                                                     
IF EXISTS(SELECT groupid                   
FROM   invgroupmapmaster                                                                                                                          
WHERE  groupid = @GrpID                                                                                                                          
AND parent = 'Y')                                                                   
BEGIN                                                     
UPDATE t                                                                                                       
SET    t.samplename = ''                                                        
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                
WHERE  t.grpid = @GrpID                                                                           
AND Isnull(invid, '') <> ''                                                                                                           
AND t.parentgrpid <> t.attgroupid                                         
                                                                                                                          
UPDATE t                                                                                                                      
SET    t.samplename = ''                                                 
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                    
WHERE  t.grpid = @GrpID                                                                                                                
AND Isnull(invid, '') <> ''                                           
END                                ELSE                                                                                                                          
BEGIN                                                                                                                          
UPDATE t                                                                                                                          
SET    t.samplename = ''                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                     
WHERE  t.grpid = @GrpID                                                                                                                  
AND Isnull(invid, '') <> ''                                                                                        
END                                                                                                                     
                                                                                                               
--Update test Unique Sample name to Group Smaple Name                                                                                                                          
DECLARE @Scount INT                                                                                                                          
                                                        
SELECT @Scount = Count(grpid)                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                          
WHERE  grpid = @GrpID                                                                 
AND Isnull(invid, '') = ''                                                                                                                          
          
UPDATE t                                                                                                                          
SET    t.samplename = @SampleName                                                                                                     
FROM   (SELECT grpid,                                                                                      
samplename,                                                                                                                          
Row_number()                                                                                                                          
OVER (                                                                                                                    
partition BY grpid                             
ORDER BY grpid DESC) AS RN                                                                             
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                                           
WHERE  grpid = @GrpID                                                                                   
AND Isnull(invid, '') = '') AS t                                            
WHERE  rn = @Scount                                                                          
END                   
IF ( (SELECT Count(1)                                                   
FROM   @SampleCountTable) = 1              
AND (SELECT Count(1)                                                                                                                          
FROM   @MethodCountTable) = 1 )                                                                                                 
BEGIN                                                                             
SELECT @MethodName = methodname                                                  
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                                                  
WHERE  grpid = @GrpID                                                                                                            
AND Isnull(invid, '') <> ''                                                                                                                          
GROUP  BY methodname                           
                                                              
--Update Unique Sample Name as null                                                                                                              
IF EXISTS(SELECT groupid                                                                                                
FROM   invgroupmapmaster                                                                                                                          
WHERE  groupid = @GrpID                                                                                                
AND parent = 'Y')                                           
BEGIN                                                              
UPDATE t                                                                                                                          
SET    t.methodname = ''                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                          
WHERE  t.grpid = @GrpID                                                                                                                          
AND Isnull(invid, '') <> ''                                                                                      
AND t.parentgrpid <> t.attgroupid                                                                               
END                                                                                
ELSE                                                                                                          
BEGIN                                                   
UPDATE t                                                              
SET    t.methodname = ''                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                  WHERE  t.grpid = @GrpID                                                                                                                          
AND Isnull(invid, '') <> ''            
END                                           
                                                                                                                          
--Update test Unique Sample name to Group Smaple Name                                                                                                                       
DECLARE @Mcount INT                             
                                                                                                                          
SELECT @Mcount = Count(grpid)                                                                                                                    
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                                              
WHERE  grpid = @GrpID                                             
AND Isnull(invid, '') = ''                                                                                
UPDATE t                                          
SET    t.methodname = @MethodName                                                                                                                          
FROM   (SELECT grpid,                methodname,                                                                               
Row_number()                                                         
OVER (                                                                                                                          
partition BY grpid                                                     
ORDER BY grpid DESC) AS RN                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID           
WHERE  grpid = @GrpID                                                                                                             
AND Isnull(invid, '') = '') AS t                                                                                                         
WHERE  rn = @Mcount                                                                                                                    
END                                                                                                                       
                                                 
--UPDATE T SET T.Name='  ~'+T.Name FROM @tblTempOrdInvExplodedResultOrderbyRowID T where T.GrpID= @GrpID and ISNULL(InvID,'')<>'' AND T.RootGroupID<>T.AttGroupID                                                                                   
                                                                                                                          
DELETE @SampleCountTable                                                                                                                          
                                                                                                                          
DELETE @MethodCountTable                                                                                  
                                                                                                                 
FETCH next FROM rowidcursor INTO @GrpID                                                                                                                    
END                                                                              
                                              
CLOSE rowidcursor                                                                      
                                                                                                                          
DEALLOCATE rowidcursor                                                                                                                          
END                                                                                           
                                                                     
UPDATE t                                                                                                         
SET    t.deptprintseparately = Isnull(IDM.printseparately, 'N')                        
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                
INNER JOIN invdeptmaster IDM                                                                                                                      
ON IDM.deptid = T.deptid                                                                                                                          
AND IDM.orgid = @OrgID                                        
                               
UPDATE @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                          
SET    rootgroupid = invid,                                                                                                                       
actualgrpid = invid                                                                                                                          
WHERE  isgroup = 'N'                                                                              
                                                                                      UPDATE t                                                                                                                          
SET    t.rootgroupid = T1.rootgroupid                                                                                                             
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                           
INNER JOIN @tblTempOrdInvExplodedResultOrderbyRowID T1                                                                                                                          
ON T1.rowid = T.rowid                                                                                                                          
WHERE  Isnull(t.rootgroupid, '') = ''                                                                                            
                                                   
DECLARE @tblDeptID TABLE                               
(                                                                                               
deptid        BIGINT,                                                                                                                          
sequenceno     INT,                                                                         
deptprintseparately CHAR(1)                                                                                                                          
)                                                          
                                                                                                                          
INSERT INTO @tblDeptID   
SELECT DISTINCT T.deptid,                                                                                                
Max(T.rowid)               AS SequenceNo,                                                                                                                          
Max(T.deptprintseparately) AS DeptPrintSeparately                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                          
GROUP  BY T.deptid                                                                                                                       
ORDER  BY sequenceno                                             
                                                                                          
DECLARE @DeptID BIGINT                                                     
DECLARE @DeptPrintSeparately CHAR(1)        
DECLARE @DeptPageNumber INT                                                                                                                          
                                                                                                                       
SET @DeptPageNumber = 1                                   
                                                                          
DECLARE deptdetailcursor CURSOR FOR                                             
SELECT deptid                                                                                                                          
FROM   @tblDeptID                                                                                                         
ORDER  BY sequenceno                                                                                                                          
                  
OPEN deptdetailcursor                                                                                                                          
                                                                         
FETCH next FROM deptdetailcursor INTO @DeptID                                                        
                                                                                   
WHILE @@FETCH_STATUS = 0                                                                                                                          
BEGIN                
SELECT @DeptPrintSeparately = deptprintseparately                       
FROM   @tblDeptID                  
WHERE  deptid = @DeptID                                                                                                                          
                                                                                                       
IF( @DeptPrintSeparately = 'Y' )                                                                                                                          
BEGIN                                                                                                                          
SET @DeptPageNumber = @DeptPageNumber + 1                                                                                                                          
                                                                                                                          
UPDATE @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                          
SET    deptpagenumber = @DeptPageNumber                                                                    
WHERE  deptid = @DeptID                                                                                                                          
                                      
SET @DeptPageNumber = @DeptPageNumber + 1                                                                                                 
END                                                                                    
ELSE                                                                               
BEGIN                                                                            
UPDATE @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                          
SET    deptpagenumber = @DeptPageNumber                                                                                             
WHERE  deptid = @DeptID                                                                         
END                                                                            
                                                                                                                    
FETCH next FROM deptdetailcursor INTO @DeptID                                                           
END                                                               
                                                              
CLOSE deptdetailcursor                       
                                                                                                                          
DEALLOCATE deptdetailcursor                                              
                                                                                                   
DECLARE @tblRootID TABLE                                                        
(                                                  
rootid                BIGINT,                                                                                                      
sequenceno            INT,                                                                                   
parentprintseparately CHAR(1)                                                                                                                          
)                                                                                                                          
                                                                                                  
INSERT INTO @tblRootID                                        
SELECT DISTINCT T.rootgroupid,                                                            
Max(T.rowid)                 AS SequenceNo,                                                                  
Max(T.parentprintseparately) AS ParentPrintSeparately                                                                
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                          
INNER JOIN investigationorgmapping IOM WITH (nolock)                                                                                                                     
ON IOM.investigationid = T.invid                                                          
AND IOM.orgid = @OrgID                                                                                                                          
WHERE  T.isgroup = 'N'                                                                                                                          
GROUP  BY T.rootgroupid                                                           
ORDER  BY sequenceno                                                                 
                                                                                                                          
INSERT INTO @tblRootID                                                                                                                          
SELECT DISTINCT T.rootgroupid,                        
Max(T.rowid)                 AS SequenceNo,                                                                         
Max(T.parentprintseparately) AS ParentPrintSeparately                         
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                          
INNER JOIN invorggroup IOG WITH (nolock)                                                                                                                          
ON IOG.attgroupid = T.rootgroupid                                                                                                                         
AND IOG.orgid = @OrgID                                                                                                                          
WHERE  T.isgroup != 'N'                                                                        
GROUP  BY T.rootgroupid                                                                                                                  
ORDER  BY sequenceno                      
                                                                                      
DECLARE @tblParentID TABLE                                                                       
(                                                                       
parentid   BIGINT,                                                            
sequenceno INT                                                                                   
)                                                               
DECLARE @ParentID BIGINT                 
DECLARE @ChildPrintSeparately CHAR(1)                                       
DECLARE @ParentPrintSeparately NVARCHAR(10)                                                                
DECLARE @ParentPageNumber INT                                                                                                                          
DECLARE @ChildPageNumber INT                                                                                                      
                                                                  
SET @ParentPageNumber = 1                                                                                                                          
SET @ChildPageNumber = 1                                                                                                                
                      
DECLARE @RootID BIGINT                                         
DECLARE invdetailcursor CURSOR FOR                                                                                                                          
SELECT rootid                                                                                      
FROM   @tblRootID                                                                                                                          
ORDER  BY sequenceno                                                                                                                          
                                                                                                                          
OPEN invdetailcursor                                                                   
                                                                                                                   
FETCH next FROM invdetailcursor INTO @RootID                                                                                      
                                                                                                                          
WHILE @@FETCH_STATUS = 0                                                                                                                  BEGIN                                                                                                               



  
    
    
    
      

      
      
        
           
SELECT @ParentPrintSeparately = parentprintseparately                                                                                                    
FROM   @tblRootID                                                                       
WHERE  rootid = @RootID                                                                          
                                                                                                                          
IF( @ParentPrintSeparately = 'Y' )                                                                                                 
BEGIN                                                                                                                    
SET @ParentPageNumber = @ParentPageNumber + 1                                                                                                   
                                                            
UPDATE @tblTempOrdInvExplodedResultOrderbyRowID                                                                 
SET    parentpagenumber = @ParentPageNumber                                  
WHERE  rootgroupid = @RootID                                                                                       
                                                                                                                          
SET @ParentPageNumber = @ParentPageNumber + 1                                                                                                            
END                                                         
ELSE                                                                                                                          
BEGIN                                                                                                         
UPDATE @tblTempOrdInvExplodedResultOrderbyRowID                                                                                       
SET    parentpagenumber = @ParentPageNumber                                                                  
WHERE  rootgroupid = @RootID                                                                                                                       
END                                                                                                                          
                                                                 
INSERT INTO @tblParentID                                                                                   
SELECT DISTINCT parentgrpid,                         
Max(rowid) AS SequenceNo                                                                      
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                                  
WHERE  rootgroupid = @RootID                                                                                                                          
GROUP  BY parentgrpid                                                                                                                          
ORDER BY sequenceno                                                                                                                          
                                                                                                                          
DECLARE grpdetailcursor CURSOR FOR                                                                                                                          
SELECT parentid                                                                                                                          
FROM   @tblParentID                                                                                        
ORDER  BY sequenceno                                                                         
                                                                      
OPEN grpdetailcursor                                                                                                             
                                                                                                                      
FETCH next FROM grpdetailcursor INTO @ParentID                                                                                                                          
                                                                                                                          
WHILE @@FETCH_STATUS = 0                                                                                                        
BEGIN                                                                                       
SELECT @ChildPrintSeparately = childprintseparately                                                                                                                          
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                                                      
WHERE  rootgroupid = @RootID                                         
AND parentgrpid = @ParentID                                                  
                                                                                                                          
IF( @ChildPrintSeparately = 'Y' )                                                                       
BEGIN                                                                         
SET @ChildPageNumber = @ChildPageNumber + 1                                                    
                                                                                                                          
UPDATE @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                          
SET    childpagenumber = @ChildPageNumber                                         
WHERE  rootgroupid = @RootID                                                                                                                         
AND parentgrpid = @ParentID                                                                                                                          
                                                                                                                          
SET @ChildPageNumber = @ChildPageNumber + 1                                                                   
END                       
ELSE                                              
BEGIN                                                                       
UPDATE @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                           
SET    childpagenumber = @ChildPageNumber                                                                              
WHERE  rootgroupid = @RootID                                                                                                                          
AND parentgrpid = @ParentID                                                                                                                  
END                                                                                                                          
                                                                                                                          
FETCH next FROM grpdetailcursor INTO @ParentID                                                                                            
END                                                                                            
                                                                                           
CLOSE grpdetailcursor                                                                               
                                                     
DEALLOCATE grpdetailcursor                                                          
                                                                            
FETCH next FROM invdetailcursor INTO @RootID                                                                                                              
END                                                              
                                                                                           
CLOSE invdetailcursor                                                                                                                          
                                                                                                   
DEALLOCATE invdetailcursor                                                                           
                                                                                                                          
UPDATE t                                
SET    t.approvername = Isnull(S.titlename, '') + ' ' + U.name,                                                                                                           
t.approverqualification = U.qualification                                                                                     
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                
INNER JOIN login L                                                                                         
ON L.loginid = T.approvedby                                                                  
INNER JOIN users U                                                                               
ON U.loginid = L.loginid                          
AND U.ORgID = @OrgID                                                                                                                          
LEFT JOIN salutation S                                                                                                                           
ON S.titleid = U.titlecode                                                                            
                                                                                
UPDATE t                                                                                                                          
SET    t.authorizername = Isnull(S.titlename, '') + ' ' + U.name,                 
t.authorizerqualification = U.qualification                                                                                     
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                          
INNER JOIN login L                                                                                                                         
ON L.loginid = T.authorizedby                                                                                                                          
INNER JOIN users U                                                        
ON U.loginid = L.loginid                                                                                                                          
AND U.ORgID = @OrgID                                   
LEFT JOIN salutation S                                                                                                         
ON S.titleid = U.titlecode                                                                                                                 
                           
UPDATE t                                           
SET    packagename = OI.pkgname ,pkgid=OI.PkgID                                                      
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                          
INNER JOIN orderedinvestigations OI                                                                                                          
ON OI.accessionnumber = T.accessionno                                                                                                                          
WHERE  OI.orgid = @OrgID                                               
AND OI.visitid = @pVisitID                                                       
AND Isnull(OI.pkgname, '') <> ''                                                            
                                                                                                                          
/***Code End***/                                               
DECLARE @ClientId BIGINT                                                                                                                       
DECLARE @ClientTempTable TABLE                                                                                                            
(                                                                                      
blockfrom DATETIME,                                                                         
blockto   DATETIME,                     
status    CHAR(10)                                                                                                                          
)                                    
                                                                   
SELECT @ClientId = VCM.clientid                                                                           
FROM  patient P                                                                                                                          
INNER JOIN patientvisit PV WITH (NOLOCK)                                                                                                                          
ON P.patientid = PV.patientid                                                                                                                          
INNER JOIN visitclientmapping VCM WITH (NOLOCK)                                                                         
ON VCM.visitid = pv.patientvisitid                                                                                                  
WHERE  VCM.visitid = @pVisitID            
AND VCM.orgid = @OrgID         
                                                                                                            
--select @ClientId                                                         
INSERT INTO @ClientTempTable                                                                                                           
SELECT cm.blockfrom,                                                                                                                          
cm.blockto,                                                                                                                          
CM.status                                                                                                                          
FROM   clientmaster CM WITH (NOLOCK)                                                                                                                          
WHERE  CM.clientid = @ClientId                                                                                                                       
AND cm.orgid = @OrgID                                                                               
AND CM.status = 'S'                                                                                        
                                                                                                                          
DECLARE @Cstatus CHAR(10)                                                                                                                          
                 
SELECT @Cstatus = status                                              
FROM   @ClientTempTable                                                                                                               
                                                                                                                          
IF( Isnull(@Cstatus, '') = '' )                                                                                                                          
SET @Cstatus='XX'                                                                                                                       
                                                                                                                          
DECLARE @tempResult TABLE                             
(                                                                                                            
rowid                   INT,                                                                                                             
name                    VARCHAR(max),                     
result                  VARCHAR(max),                                                                                                                          
units                   VARCHAR(100),                       description         VARCHAR(max),                                                                             
referencerange          VARCHAR(max),                                                                 
           PrintableRange          VARCHAR(max),        
investigationid         BIGINT,                                                                                                                          
methodname              VARCHAR(500),                                                                                                                          
notes          VARCHAR(max),                                                                                                  
samplename              VARCHAR(500),                                                         
isabnormal              VARCHAR(50),                                                                                                                  
medicalremarks      VARCHAR(max),                                       
refrangesuffixtest      VARCHAR(max),                                                          
deptid                  BIGINT,                                                                                                                          
grpid                   BIGINT,                                                                         
isnonreportable         CHAR(1),                                                                 
approvedby              BIGINT,                                                                                                                          
approvername            NVARCHAR(500),                                                                                                  
approverqualification   NVARCHAR(500),                                                                                                
rootgroupid             BIGINT,                                                                                                                          
parentgrpid             BIGINT,                           
deptprintseparately     CHAR(1),                                                                                          
deptpagenumber    INT,                                                            
parentprintseparately   CHAR(1),                                                                                                                          
parentpagenumber        INT,                                                
childprintseparately    CHAR(1),                        
childpagenumber         INT,                                                                                                              
authorizedby            BIGINT,                                                                                                                          
authorizername          NVARCHAR(500),                                                                  
authorizerqualification NVARCHAR(500),                       
patientvisiid           BIGINT,                                                                                      
packagename             NVARCHAR(max),                                                                                                                          
applicationurl          NVARCHAR(max),                                                                          
isrejected              CHAR(1),                                                                                                                          
iswithheld              CHAR(1),                                                                                                 
recheckretest           NVARCHAR(20),                                                             
convreferencerange      NVARCHAR(max),                    
convvalue               VARCHAR(max),                                                                                                                          
headerid      BIGINT,                                                                                                                        
headername              VARCHAR(200),                                                                                                     
convuomcode             VARCHAR(50),                                                                                  
GroupMedicalRemarks     varchar(255),                                                                        
OtherLanguage                NVARCHAR(200),                                                     
OtherLanguageHeader NVarchar(200),                                                                    
convvalue01               VARCHAR(max),                                                       
convuomcode01            VARCHAR(50),                                    
convreferencerange01     NVARCHAR(max),                    
AbnormalFlagsymbol NVARCHAR(max),                  
ConvAbnormalFlagSymbol NVARCHAR(MAX) ,            
PkgId           INT                                                           
)                                                                        
                                                                                                                      
--select @Cstatus                                                           
                                                                                                                          
DECLARE @ApplicationURL NVARCHAR(max)                                                                                            
                                                                                                         
SELECT @ApplicationURL = COM.configvalue                                                                                                                          
FROM   configorgmaster COM WITH (NOLOCK)                                                         
INNER JOIN configkeymaster CKM WITH (NOLOCK)                              
ON CKM.configkeyid = COM.configkeyid                                                                           
WHERE  CKM.configkey = 'ApplicationURL'                                                                                                                       
AND COM.orgid = @OrgID                                       
               
SET @ApplicationURL=Isnull(@ApplicationURL, '')                                      
+ '/Images/Signature/ID'                                                                                                                          
                                                                                                                          
                                                                                 
                                                                                                                          
IF ( @Cstatus <> 'S' )                                                                                                                          
BEGIN                                                                                                                        
                                                                                                 
                                                                                                                          
DECLARE @tempResultWithReportable TABLE                                                                                                                          
(                                                                                                     
rowid  INT,    
name VARCHAR(max),                                                                                              
result                VARCHAR(max),                                                                                                                          
units                   VARCHAR(100),                                                        
description             VARCHAR(max),                                                                                                                          
referencerange          VARCHAR(max),                                                                                                
                 PrintableRange          VARCHAR(max),        
investigationid         BIGINT,                                                                    
methodname              VARCHAR(500), 
notes                   VARCHAR(max),                                                                                                                         
samplename              VARCHAR(500),                                                      
isabnormal              VARCHAR(50),                                                                                                                  
medicalremarks          VARCHAR(max),                                                                                                                          
refrangesuffixtest      VARCHAR(max),                                                                                                                          
deptid         BIGINT,                                                                                                              
grpid                   BIGINT,                                                                                                                          
isnonreportable         CHAR(1),                                                                                                    
approvedby              BIGINT,       
approvername   NVARCHAR(500),                                                                                                                          
approverqualification   NVARCHAR(500),                                                                                                        
rootgroupid         BIGINT,                                      
parentgrpid             BIGINT,                                                                                                                          
deptprintseparately     CHAR(1),                               
deptpagenumber          INT,                                                                                    parentprintseparately   CHAR(1),                                        
parentpagenumber        INT,                                                                                                                          
childprintseparately    CHAR(1),                                                                                                                          
childpagenumber         INT,                                       
authorizedby            BIGINT,                                                                   
authorizername          NVARCHAR(500),                                                                                      
authorizerqualification NVARCHAR(500),                                                                                                                          
patientvisiid           BIGINT,                                                                                                                          
packagename             NVARCHAR(max),                                                                                                        
applicationurl     NVARCHAR(max),                                                                                                   
isrejected              CHAR(1),                                                                      
iswithheld CHAR(1),                                                                               
recheckretest           NVARCHAR(20),                                            
convreferencerange      NVARCHAR(max),                                                                                                                          
convvalue               VARCHAR(max),                                                                                                       
headerid                BIGINT,                                                                                                                          
headername              VARCHAR(200),                                                                                          
convuomcode             VARCHAR(50),                                                                        
OtherLanguage    NVARCHAR(200)        ,         
OtherLanguageHeader NVarchar(200)                                                                        
)                                                                                  
                                                                        
/*--------------- Modified By Sathish.E------------*/                                                                        
/*-----Abnormal Value Highlighted by Client Level  */                                                                         
                       
Declare @TempTable1 as Table                                                                         
(                                                                        
Clientid int,                                                                        
Tag varchar(255),                                                     
VisitId bigint,                                                                        
Orgid int,                   
InvestigationId int                                                                        
)                                                
/*------------------------- End---------------------*/                                                                        
INSERT INTO @tempResultWithReportable                                                                                                                 

SELECT rowid,                                                                                                                          
name,                                                         
ISNULL(REPLACE(result,'~','<br>'),'')                                                                            
As Result,                                                                                
---Isnull(result, '')                  AS Result,                                        
Isnull(units, '')                   AS Units,                                                                                                                          
Isnull(technicalremarks, '')        AS Description,                                                                 
Isnull(referencerange, '')          AS ReferenceRange,                                                                                      
                  Isnull(PrintableRange, '')               AS PrintableRange,                         
Isnull(invid, '')                   AS InvestigationID,                                                                                                                          
Isnull(methodname, '')              AS MethodName,                                                            
Isnull(notes, '')                   AS Notes,                                                                   
Isnull(samplename, '')              AS SampleName,                                                                                   
isabnormal,                                                                                                                          
Isnull(medicalremarks, '')          AS MedicalRemarks,                                                                                
''        AS RefRangeSuffixtest,                      
deptid,                                                                                                                          
grpid,                                     
isnonreportable,                                                                     
Isnull(approvedby, 0)               AS ApprovedBy,                                                                                                                          
Isnull(approvername, '')            AS ApproverName,                                                                      
Isnull(approverqualification, '')   AS ApproverQualification,                                                                                                   
rootgroupid,                                                                                                                          
parentgrpid,                                                                                                                  
deptprintseparately,                                                                                                                          
deptpagenumber,                                                                                  
parentprintseparately,                                                                                                                          
parentpagenumber,                                                                                                                          
childprintseparately,                                                                     
childpagenumber,                                                                              
Isnull(authorizedby, 0)             AS AuthorizedBy,                                                                                       
Isnull(authorizername, '')          AS AuthorizerName,                                                                               
Isnull(authorizerqualification, '') AS                                           
AuthorizerQualification,                                                                                                                         
patientvisiid,                                                                                                                          
Isnull(packagename, '')             AS PackageName,                                                                                                                          
@ApplicationURL                     AS ApplicationURL,                              
Isnull(isrejected, 'N')             AS IsRejected,                                                                                                                          
Isnull(iswithheld, 'N')             AS Iswithheld,                                                                                                                          
retestrecheck,                                                              
Isnull(convreferencerange, '')      AS ConvReferenceRange,                                                                                                                          
CASE                                                             
WHEN convvalue = '0' THEN ''        
ELSE convvalue                           
END       AS ConvValue,                                                                                                                          
0                                   AS HeaderID,                                                                                                                       
''               AS HeaderName,                            
''                             ConvUOMCode,                                                                        
''    AS        OtherLanguage,                                                                        
''   AS OtherLanguageHeader              
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                           
WHERE  result = ''                                                                                                 
            
UNION                                        
                                                                                
SELECT T.rowid,                         
T.name,                                        
Isnull(result, '')                  AS Result,                                 
Isnull(units, '')                   AS Units,                                                                                                                          
Isnull(technicalremarks, '')        AS Description,                                                                                                                          
Isnull(T.referencerange, '')        AS ReferenceRange,                                                                              
Isnull(T.PrintableRange, '')        AS PrintableRange,                                                                              
Isnull(invid, '')                   AS InvestigationID,                                                                                                                          
Isnull(methodname, '')              AS MethodName,                            
Isnull(notes, '')                   AS Notes,                                                                                          
Isnull(samplename, '')            AS SampleName,                                                                                                                      
isabnormal,                                                                                   
Isnull(medicalremarks, '')          AS MedicalRemarks,                                                                                                         
''                                  AS RefRangeSuffixtest,                                                                                                                          
T.deptid,                                                                                                                          
grpid,                                                                                                                          
T.isnonreportable,                         Isnull(approvedby, 0)               AS ApprovedBy,                                                                                                                          
Isnull(approvername, '')            AS ApproverName,                                                                                                                          
Isnull(approverqualification, '')   AS ApproverQualification,                                                                                                                       
rootgroupid,                                                                                                                          
parentgrpid,                                                
deptprintseparately,                                                                            
deptpagenumber,                                                                                                         
parentprintseparately,                                                          
parentpagenumber,                                                                                                                          
childprintseparately,                                                                                                                          
childpagenumber,       
Isnull(authorizedby, 0)             AS AuthorizedBy,                                                                                                                          
Isnull(authorizername, '')          AS AuthorizerName,                           
Isnull(authorizerqualification, '') AS                                                                                                                          
AuthorizerQualification,                                                                                                                 
patientvisiid,                                              
Isnull(packagename, '')             AS PackageName,                                                                                                 
@ApplicationURL               AS ApplicationURL,                                                                                                
Isnull(isrejected, 'N')             AS IsRejected,                                                                                  
Isnull(iswithheld, 'N')             AS Iswithheld,                                                                            
retestrecheck,                                                                                                            
Isnull(convreferencerange, '')      AS ConvReferenceRange,                                 
CASE                                                                                                                          
WHEN convvalue = '0' THEN ''                                             
ELSE convvalue                                                               
END                                 AS ConvValue,                            
IH.headerid,                                                                                                                          
IH.headername,                                                                                                                          
IOM.conv_uomcode     AS ConvUOMCode,                                                                        
IOM.OtherLanguage      AS   OtherLanguage,                                                
isnull(IH.OtherLanguageHeader,'')  as OtherLanguageHeader                                                                         
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                    
LEFT JOIN investigationorgmapping IOM WITH (NOLOCK)                                                                                          
ON IOM.investigationid = T.invid                                                                                                               
AND orgid = @OrgID                                                                                                                          
LEFT JOIN investigationheader IH WITH (NOLOCK)                                                                                                                          
ON IH.headerid = IOM.headerid                                                              
                                                                     
 
   /*--------------- Modified By Sathish.E------------*/                                                                        
  /*-----Abnormal Value Highlighted by Client Level  */                                                                              
                                           
INSERT INTO @TempTable1                                                                          
SELECT  CASE WHEN RRM.Clientid =VCM.ClientID THEN VCM.ClientID ELSE 0 END AS Clientid,                                                                        
RRM.tag,OI.VisitID,OI.Orgid,OI.ID       
FROM @tempResultWithReportable T                                                                            
INNER JOIN OrderedInvestigations OI WITH (NOLOCK) ON OI.VisitID=@pVisitID                                                         
INNER JOIN PatientInvestigation  PIS (nolock) ON PIS.AccessionNumber=OI.AccessionNumber                                                         
and PIS.InvestigationID=T.investigationid                                                        
LEFT JOIN VisitClientMapping VCM WITH (NOLOCK) ON VCM.VisitID=OI.VisitID AND VCM.OrgID=OI.OrgID                                  
LEFT JOIN ReferenceRangeMapping RRM  WITH(NOLOCK) on RRM.Clientid=VCM.ClientID                                                            
                                                          
                                                                       
              --Select investigationid,* from @tempResultWithReportable                                                        
              --Select * from @TempTable1                                                        
              --return                                                      
                                         
                                                      
                                                                      
INSERT INTO @tempResult                                      
                                                                                    
SELECT                                                                  
rowid,                                          
name,                            
ISNULL(REPLACE(result,'~','<br>'),'')    AS Result,                                               
Isnull(units, '')           AS Units,                                                                                        Isnull(technicalremarks, '')        AS Description,                                                                              



  
            
              
                
                  
                    
                      
                                                    
Isnull(referencerange, '')          AS ReferenceRange,                                                                          
Isnull(PrintableRange, '')        AS PrintableRange,                                                                                    
Isnull(invid, '')                   AS InvestigationID,                                                                                                           
Isnull(methodname, '')              AS MethodName,     
case when Isnull(notes, '')!='' then notes + '<br>' Else Isnull(notes, '') End AS Notes,    
--Isnull(notes, '')                   AS Notes,                                                                                                  
    
    
    
      
      
      
      
                                 
Isnull(samplename, '')              AS SampleName,                                                                                                                          
isabnormal,                                                                                                                          
case when Isnull(medicalremarks, '')!='' then medicalremarks + '<br>' Else Isnull(medicalremarks, '') End AS MedicalRemarks,                                                                                                                                
--Isnull(medicalremarks, '')          AS MedicalRemarks,                                                                          
''                                 AS RefRangeSuffixtest,                                                                           
deptid,     
grpid,                                                                                                                                  
isnonreportable,                                                                                                         
Isnull(approvedby, 0)               AS ApprovedBy,                                                                                                                                  
Isnull(approvername, '')            AS ApproverName,                                                                    
Isnull(approverqualification, '')   AS ApproverQualification,                                                                                                                                  
rootgroupid,                      
parentgrpid,                                                              
deptprintseparately,                                                                               
deptpagenumber,                                                             
parentprintseparately,                                                                                                                   
parentpagenumber,                                                                                                                                  
childprintseparately,                                                                                                                         
childpagenumber,                                                                             
Isnull(authorizedby, 0)  AS AuthorizedBy,                                                                                                                                  
Isnull(authorizername, '')          AS AuthorizerName,                                                      
Isnull(authorizerqualification, '') AS                                                                                                                                  
AuthorizerQualification,                                                                                                                                  
patientvisiid,                                                                                                           
Isnull(packagename, '')             AS PackageName,                         
@ApplicationURL                     AS ApplicationURL,                                                                                                        
Isnull(isrejected, 'N')             AS IsRejected,                                                                              
Isnull(iswithheld, 'N')       AS Iswithheld,                                                                                                                                  
retestrecheck,                                   
Isnull(convreferencerange, '')      AS ConvReferenceRange,                                                                                                                                  
CASE                                                      
WHEN convvalue = '0' THEN ''                              
ELSE convvalue                                       
END                 AS ConvValue,                                     
0     AS HeaderID,                                                                                                                                  
''                AS HeaderName,                                                                                                                                  
''                                  ConvUOMCode ,                                                                               
GroupMedicalRemarks,                                                
'' as  OtherLanguage,                                                                                
 OtherLanguageHeader,                                                                            
 '' as  ConvValue01,                             
 '' as ConvUOMCode01,                                                                            
 '' as ConvReferenceRange01,                            
 AbnormalFlagsymbol,ConvAbnormalFlagSymbol , ISNULL(pkgid,'') as pkgid                                                                                                
                                                                              
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                                  
WHERE  result = ''                                                                           
AND isnonreportable <> 'Y'                                                                                                                                  
                                                               
                                             
UNION                                                                                       
                         
SELECT                                                                               
T.rowid,                                                                 
T.name,                                          
--Isnull(result, '')                  AS Result,                                                                                 
--Case When LEN(RRM.tag)>0 and isabnormal in('A','L','P') then REPLACE(RRM.tag,'{result}',T.result)else ISNULL(REPLACE(T.result,'-','<br>'),'') End                                                                                
ISNULL(REPLACE(T.result,'~','<br>'),'')                      
-- T.result                                                     
 as Result,                                                                                         
Isnull(units, '')                   AS Units,                                                                                                                                  
Isnull(technicalremarks, '')        AS Description,                                                                                                               
Isnull(T.referencerange, '')        AS ReferenceRange,                                                                                                              
Isnull(T.PrintableRange, '')        AS PrintableRange,                                                                                                                      
Isnull(invid, '')                   AS InvestigationID,                                                                                                                                 
Isnull(methodname, '')              AS MethodName,      
case when Isnull(notes, '')!='' then notes + '<br>' Else Isnull(notes, '') End AS Notes,                                                                                                                   
--Isnull(notes, '')                   AS Notes,                                                                                           
Isnull(samplename, '')              AS SampleName,                                                                                                                                  
isabnormal,                                                                                                      
case when Isnull(t.medicalremarks, '')!='' then t.medicalremarks + '<br>' Else Isnull(t.medicalremarks, '') End AS MedicalRemarks,         
--Isnull(medicalremarks, '')      AS MedicalRemarks,                       
''                                  AS RefRangeSuffixtest,                                           
T.deptid,                                             
grpid,                                                                                                      
T.isnonreportable,                                                                         
Isnull(approvedby, 0)               AS ApprovedBy,                                                                      
Isnull(approvername, '')      AS ApproverName,                                                    
Isnull(approverqualification, '')   AS ApproverQualification,                                                                                                                                  
rootgroupid,                                                                                             
parentgrpid,                                                                                               
deptprintseparately,                                                                                
deptpagenumber,                                                     
parentprintseparately,                                                                                                                                  
parentpagenumber,                                                                                                                                  
childprintseparately,                                                                                                                                  
childpagenumber,                                                                                          
Isnull(authorizedby, 0)             AS AuthorizedBy,                         
Isnull(authorizername, '')          AS AuthorizerName,                   
Isnull(authorizerqualification, '') AS                                                                                                                                  
AuthorizerQualification,                 
patientvisiid,                                                                                                      
Isnull(packagename, '')             AS PackageName,                                                                                                                                  
@ApplicationURL                AS ApplicationURL,                                                                        
Isnull(isrejected, 'N')             AS IsRejected,                                            
Isnull(iswithheld, 'N')             AS Iswithheld,                                                                                                                                  
retestrecheck,                                                                                                          
Isnull(convreferencerange, '')      AS ConvReferenceRange,                                                               
--CASE WHEN convvalue = '0' THEN ''When  LEN(RRM.tag)>0  and isabnormal in('A','L','P') then REPLACE(RRM.tag,'{result}',T.convvalue)ELSE T.convvalue END                                                              
T.convvalue AS ConvValue,                                                                                  
IH.headerid,                                                                                    
IH.headername,                                                                                           
IOM.conv_uomcode AS ConvUOMCode,                                             
GroupMedicalRemarks,                                                                                
IOM.OtherLanguage   as OtherLanguage,                                                                                
--T.OtherLanguageHeader                              
T.OtherLanguageHeader  as OtherLanguageHeader,                                                                            
 '' as  ConvValue01,                                    
 '' as ConvUOMCode01,                                                                            
 '' as ConvReferenceRange01 ,''   as AbnormalFlagsymbol,'' as ConvAbnormalFlagSymbol , ISNULL(pkgid,'') as pkgid                                                                                                                                             




                                                                                    
FROM   @tblTempOrdInvExplodedResultOrderbyRowID T                                                                                                                                  
LEFT JOIN investigationorgmapping IOM  WITH (NOLOCK)                   ON IOM.investigationid = T.invid                   
AND orgid = @OrgID                                                                    
LEFT JOIN investigationheader IH  WITH (NOLOCK)                                                 
ON IH.headerid = IOM.headerid                                                                                                                                 
/* ------------ Sathish.E-------------  */                                                                      
--Left JOIN @TempTable1 T1 on T1.VisitId=T.patientvisiid                                                            
--LEFT JOIN ReferenceRangeMapping RRM on RRM.Clientid=T1.Clientid                                                                                
 /* ------------ Sathish.E-------------  */                                                       
                                                            
WHERE  T.result <>''and  T.isnonreportable <> 'Y' or T.isnonreportable is null                             
                                                         
--select * from @tblTempOrdInvExplodedResultOrderbyRowID                                                 --select * from @tempResult                                                                                 
  --return                           
                    
                                                                                               
                                                              
END                                                                                                                                  
ELSE                                                                
BEGIN                                                                                                    
                                 
SELECT rowid,                                                                                                                     
name,                                                                               
ISNULL(REPLACE(result,'~','<br>'),'')                AS Result,                                                                                                        
Isnull(units, '')         AS Units,                                                                                                                                  
Isnull(technicalremarks, '')        AS Description,                                                                                                                                  
Isnull(referencerange, '')          AS ReferenceRange,                                                                                                         
   Isnull(PrintableRange, '')               AS PrintableRange,                
invid     AS InvestigationID,                                                                                                                
Isnull(methodname, '')              AS MethodName,     
  case when Isnull(notes, '')!='' then notes + '<br>' Else Isnull(notes, '') End AS Notes,                   
--Isnull(notes, '')                   AS Notes,                                                                                                                                  
Isnull(samplename, '')              AS SampleName,                                                                                                                                  
isabnormal,                                                                                                                       
case when Isnull(medicalremarks, '')!='' then medicalremarks + '<br>' Else Isnull(medicalremarks, '') End AS MedicalRemarks,         
--Isnull(medicalremarks, '')          AS MedicalRemarks,                                                                                                                                  
''                                  AS RefRangeSuffixtest,                                                                                                                                  
deptid,                                                                                                                                  
grpid,                             
isnonreportable,                                                                                                                             
Isnull(approvedby, 0)   AS ApprovedBy,                                                                                                                                  
Isnull(approvername, '')            AS ApproverName,                                                                                                                           
Isnull(approverqualification, '')   AS ApproverQualification,                                         
rootgroupid,                                              
parentgrpid,                                                                                             
deptprintseparately,                                                                                
deptpagenumber,                                             
parentprintseparately,                                                       
parentpagenumber,                        
childprintseparately,                                                         
childpagenumber,                          
Isnull(authorizedby, 0)             AS AuthorizedBy,                                                                                                                                  
Isnull(authorizername, '')          AS AuthorizerName,                                                                                                                                  
Isnull(authorizerqualification, '') AS                                     
AuthorizerQualification,                                                                                     
patientvisiid,                                                                                                                                  
Isnull(packagename, '')             AS PackageName,                                                                                                                                  
@ApplicationURL      AS ApplicationURL,                                                                                                  
Isnull(isrejected, 'N')             IsRejected,                                                               
Isnull(iswithheld, 'N')             Iswithheld,                                       
retestrecheck,                                                                
Isnull(convreferencerange, '')      AS ConvReferenceRange,                                                                                                                                  
CASE                                                     
WHEN convvalue = '0' THEN ''                                                                                                                                  
ELSE convvalue                                                                                          
END                                 AS ConvValue,                                                                                          
0                                   AS HeaderID,                                      
''                                  AS HeaderName,                                                                                          
''       AS ConvUOMCode,                                                                                
''                   as  OtherLanguage,                                                                                
OtherLanguageHeader,                                                                            
 '' as  ConvValue01,                                                                            
 '' as ConvUOMCode01,                                                                            
 '' as ConvReferenceRange01 ,''  as AbnormalFlagsymbol ,'' as ConvAbnormalFlagSymbol,  ISNULL(pkgid,'') as pkgid                                                                                          
                                                               
FROM   @tblTempOrdInvExplodedResultOrderbyRowID                                                                                                                                  
WHERE  isabnormal = 'P'                                                                                                          
AND result = ''                                                                                                
AND isnonreportable <> 'Y'                                                                                                                       
OR isnonreportable IS NULL                                                            
--and IsAbnormal='P' or                                                                                                                                        
--Order by RowID                                       
UNION ALL                                                            
SELECT tbl.rowid,                       
tbl.name                            AS Name,                                                              
ISNULL(REPLACE(result,'~','<br>'),'')                                                                                    
  as Result,                                
Isnull(units, '')                   AS Units,                                                                                                   
Isnull(technicalremarks, '')        AS Description,                                                            
Isnull(tbl.referencerange, '')      AS ReferenceRange,                                                                                                                                  
                   Isnull(tbl.PrintableRange, '')           AS PrintableRange,                
invid                               AS InvestigationID,                                                                                                                                  
Isnull(methodname, '')              AS MethodName,    
case when Isnull(notes, '')!='' then notes + '<br>' Else Isnull(notes, '') End AS Notes,                      
--Isnull(notes, '')                   AS Notes,                                                                
Isnull(samplename, '')              AS SampleName,  
isabnormal,                 
--Add by selva medicalremarks                                                                                                                       
case when Isnull(tbl.medicalremarks, '')!='' then tbl.medicalremarks + '<br>' Else Isnull(tbl.medicalremarks, '') End AS MedicalRemarks,           
--Isnull(medicalremarks, '') as MedicalRemarks,                                                                                                                               
''                              AS RefRangeSuffixtest,                                                                                           
tbl.deptid            AS DeptID,                                                                                                                                  
grpid,                                                                                                       
tbl.isnonreportable,                                                          
Isnull(approvedby, 0)               AS ApprovedBy,                                                                                                     
Isnull(approvername, '')  AS ApproverName,                                                                                
Isnull(approverqualification, '')   AS ApproverQualification,                                                                                                                                  
rootgroupid,                                                                        
parentgrpid,                                                                                                                       
deptprintseparately,                                                                                                                            
deptpagenumber,                          
parentprintseparately,                                                                                                                                  
parentpagenumber,                                                                                                                                  
childprintseparately,                                                                                                                                  
childpagenumber,                                                                                                                                  
Isnull(authorizedby, 0)             AS AuthorizedBy,                
Isnull(authorizername, '')          AS AuthorizerName,                                
Isnull(authorizerqualification, '') AS                                                        
AuthorizerQualification,                                                                                                    
patientvisiid,                                                                                  
Isnull(packagename, '') AS PackageName,                                     
@ApplicationURL                     AS ApplicationURL,                                                                                                              
Isnull(isrejected, 'N')             IsRejected,                                 
Isnull(iswithheld, 'N')             Iswithheld,                         
retestrecheck,                                                                                                                                  
Isnull(convreferencerange, '')      AS ConvReferenceRange,                                                                                                                                  
CASE                                                
WHEN convvalue = '0' THEN ''                     
ELSE convvalue                                               
END                                 AS ConvValue,                                                                                                        
IH.headerid,                                                                                                               
IH.headername,                                                                                                                                  
IOM.conv_uomcode                    AS ConvUOMCode  ,                                                                                
IOM.OtherLanguage           as OtherLanguage,                   
--isnull(tbl.OtherLanguageHeader,'')                                                                                 
'' as OtherLanguageHeader,                                                                            
 '' as  ConvValue01,                                                                            
 '' as ConvUOMCode01,                                                                            
 '' as ConvReferenceRange01,'' as AbnormalFlagsymbol,'' as ConvAbnormalFlagSymbol,                                                                   
 ISNULL(pkgid,'') as pkgid                    
                                                                                    
FROM   @tblTempOrdInvExplodedResultOrderbyRowID tbl                                                                                                                                  
INNER JOIN finalbill FB WITH (NOLOCK)                                                                       
ON tbl.patientvisiid = FB.visitid                                                                                                                                  
INNER JOIN billingdetails BD WITH (NOLOCK)                                                                                                                                  
ON BD.finalbillid = FB.finalbillid                                       
LEFT JOIN investigationorgmapping IOM  WITH (NOLOCK)                                                                   
ON IOM.investigationid = tbl.invid                                                                                                                         
AND IOM.orgid = @OrgID                                                                                                                                  
LEFT JOIN investigationheader IH  WITH (NOLOCK)                                                                                                                                 
ON IH.headerid = IOM.headerid                                                         
WHERE  BD.isstat = 'Y'                                                                                                                                  
AND tbl.isnonreportable <> 'Y'                                                                        
END            
                                                             
                                       
--SELECT * FROM @tempResultWithReportable                                                                                                                             
--UPDATE @tempResult                               
--SET ConvuomCOde='/hpf',ConvReferenceRange='0-1', convvalue =                                                                                             
--( CASE                         
--WHEN (result <= 5) THEN '0-1'                                         
--WHEN (result between 6 and 10) THEN '2-4'                        
--WHEN (result between 11 and 25) THEN '5-9'                                                                                             
--WHEN (result between 26 and 50) THEN '10-29'                                   
--WHEN (result between 51 and 150) THEN '30-49'            
--WHEN (result between 151 and 250) THEN '50'                                                                                             
--ELSE  ('>50')                                                                                            
--END ) where investigationid=4007                                                            
                                                                                            
--UPDATE @tempResult                                                                                             
--SET ConvuomCOde='/hpf',ConvReferenceRange='0-4', convvalue =                                                                                             
--( CASE                                                                                              
--WHEN (result <= 10) THEN '0-4'                                                                                             
--WHEN (result between 10 and 25) THEN '5-19'                                                                                             
--WHEN (result between 26 and 100) THEN '20-99'                                                                                             
--WHEN (result between 101 and 500) THEN '100'                                                            
--ELSE  ('>100')                                                                                     
--END ) where investigationid=9513                                                
                                                            
                                                            
--UPdate  T                                                            
--set result=Case When LEN(RRM.tag)>0 and isabnormal in('A','L','P') then                                                             
--REPLACE(RRM.tag,'{result}',T.result)else ISNULL(REPLACE(T.result,'~','<br>'),'') End,                                                            
--convvalue=CASE WHEN convvalue = '0' THEN ''When  LEN(RRM.tag)>0  and isabnormal in('A','L','P') then                                                             
--REPLACE(RRM.tag,'{result}',T.convvalue)ELSE T.convvalue END                                                            
--From  @tempResult T                                                             
--Left JOIN @TempTable1 T1 on T1.VisitId=T.patientvisiid                                                                                 
--LEFT JOIN ReferenceRangeMapping RRM on RRM.Clientid=T1.Clientid                                                            
--where isabnormal in('A','P','L')                               
--UPdate  T                                                                    
--set result=Case When LEN(RRM.tag)>0 and isabnormal in('A','L','P') then '<B>'+T.result+'</B>'                                                                                              
--else ISNULL(REPLACE(T.result,'~','<br>'),'') End,            
--convvalue=CASE WHEN convvalue = '0' THEN ''When  LEN(RRM.tag)>0  and isabnormal in('A','L','P') then                                            
--'<B>'+T.convvalue+'</B>' ELSE T.convvalue END                                      
--From  @tempResult T                                                                               
--Left JOIN @TempTable1 T1 on T1.VisitId=T.patientvisiid                                                                                                       
--LEFT JOIN ReferenceRangeMapping RRM on RRM.Clientid=T1.Clientid                                                                                  
--where isabnormal in('A','P','L')                              
                                               
                                                          
--UPDATE @tempResult SET AbnormalFlagsymbol='*' WHERE  isabnormal in('A','P','L')                            
--UPDATE @tempResult SET AbnormalFlagsymbol='<B>*</B>' WHERE  isabnormal in('A','P','L')                                                                                       
                                                                                                                            
--UPDATE @tempResult SET result='<B>' + result+'*</B>',convvalue =                                     
-- CASE When ISNULL(convvalue,'') = ''                                                                                                  
--     then ''                                                             
--     ELSE  '<B>' + convvalue  +'*</B>'                                                                                                 
                                                                                                     
--     END                                                                                                
--from @tempResult where isabnormal in ('A','L','P')                                                                                             
--UPDATE @tempResultWithReportable SET result='<B>' + result + '*</B>' ,convvalue =                                                                                                   
                                                                                                  
-- CASE When ISNULL(convvalue,'') = ''                                                 
--     then ''                                                                                                  
--     ELSE   '<B>' + convvalue  +'*</B>'                                                                                                   
                                                                                                       
--     END                                           
--from @tempResultWithReportable where isabnormal in ('A','L','P')                                                                                       
 /*-----Added By Murali------   */                                                                                              
/*                                                                                   
 Author  : Venkat                                                                                           
 Purpose : Show side by Side Report for Qunatum.                                                                                                                              
 EX : 6113   Neutrophils (Device values) 50 mg/dl                                                                               
   2005   Neutrophils (Caluclates Field) 56 %                                                 
   In our Exsisting Report Report is like this                                                                                                                     
                             
   Name   Value Units                                                                        
   ----   ----  -----                                                                          
   Neutrophils   50 mg/dl                 
   Neutrophils   56 %                                                                                    
                                                                                        
 But for Qunantum : Report will be like this                                                                                                                                  
                                                                                                                             
   Name   Value Units  ConvValue and Unit     
   ----   ----  -----  ------------------                                                                                                                          
   Neutrophils   50 mg/dl   56 %                                            
                                                                               
                                                         
*/                                                                                                                                
DECLARE @TblsideByside as table                                                                                                                                
(                                  
 RowID BIGINT IDENTITY (1,1),                                                                                               
 GroupID BIGINT,                                                                                                                
 FColInvestigationID BIGINT,                                                                                                                              
 ScolInvestigationID BIGINT,                                                                                                                                
 Type Varchar(255)                                                                                                                                
)                                                                                                                                
                                                                                                                                
Insert into @TblsideByside SELECT 19,6113,2005,'InvValueAsConvValue'                                                                                                                         
Insert into @TblsideByside SELECT 19,8669,2006,'InvValueAsConvValue'                                                                                                 
 Insert into @TblsideByside SELECT 19,8670,4055,'InvValueAsConvValue'                                                    
Insert into @TblsideByside SELECT 19,2011,2007,'InvValueAsConvValue'                                                                                                                                          
Insert into @TblsideByside SELECT 19,8671,2008,'InvValueAsConvValue'                                            
Insert into @TblsideByside SELECT 19,10085,9420,'InvValueAsConvValue'                                                  
Insert into @TblsideByside SELECT 19,9421,9425,'InvValueAsConvValue'                                          
Insert into @TblsideByside SELECT 19,9423,9419,'InvValueAsConvValue'                                             
Insert into @TblsideByside SELECT 19,4722,8667,'InvValueAsConvValue'                                         
Insert into @TblsideByside SELECT 19,5733,9422,'InvValueAsConvValue'                                                                 
Insert into @TblsideByside SELECT 7,9413,6072,'InvValueAsConvValue'                            
Insert into @TblsideByside SELECT 7,9412,9073,'InvValueAsConvValue'                            
Insert into @TblsideByside SELECT 7,10359,10362,'InvValueAsConvValue'                            
Insert into @TblsideByside SELECT 7,10363,10360,'InvValueAsConvValue'                            
Insert into @TblsideByside SELECT 7,10364,10361,'InvValueAsConvValue'                
                                                                     
--Insert into @TblsideByside SELECT 7,6072,9413,'InvValueAsConvValue'                            
--Insert into @TblsideByside SELECT 7,9073,9412,'InvValueAsConvValue'                            
--Insert into @TblsideByside SELECT 7,10362,10359,'InvValueAsConvValue'                    
--Insert into @TblsideByside SELECT 7,10360,10363,'InvValueAsConvValue'                   
--Insert into @TblsideByside SELECT 7,10361,10364,'InvValueAsConvValue'         
--Insert into @TblsideByside SELECT 29,6139,6006,'SideBySide'                                                                                                                        
--Insert into @TblsideByside SELECT 29,9511,3134,'SideBySide'                                                                                                                        
--Insert into @TblsideByside SELECT 29,4005,8893,'SideBySide'              
--Insert into @TblsideByside SELECT 29,4004,8872,'SideBySide'                                                                                         
--Insert into @TblsideByside SELECT 29,9512,4453,'SideBySide'                                                                                                                        
--Insert into @TblsideByside SELECT 29,8894,6116,'SideBySide'                                                   
                                     
                                                    
                                                    
                                                                                                                   
DECLARE @Count AS INT                                                                                                                         
DECLARE @loop AS INT = 1                                                                                                                        
                                                                                           
SELECT @Count = COUNT(1) from @TblsideByside                                                                                                     
--SELECT COUNT(1) from @TblsideByside                                                                                                          
WHILE (@loop <= @Count)                                                                                                    
BEGIN                                                                                                                        
                                                                           
 Declare @tblGrpID as BIGINT                                                                                                                        
 Declare @tblFInvID as BIGINT                                                                                                                        
 Declare @tblSInvID as BIGINT                                                                                                            
 Declare @Type varchar(255)                                                                                                                                                                                                                               
 SELECT @Type = Type,@tblGrpID = GroupID,@tblFInvID = FColInvestigationID,@tblSInvID = ScolInvestigationID                                                                                          
 FROM @TblsideByside WHERE RowID = @loop                                                       
                                                                  
IF (@Type = 'InvValueAsConvValue')                                                                                                                
                                                                                                                        
BEGIN                                                                                                                        
      
  IF EXISTS (Select 1 from @tempResult where headerid = @tblGrpID)                                                                                                                                                               
    BEGIN                                                                         
    --print '1'                                                                                                                          
     IF EXISTS (Select 1 from @tempResult where investigationid = @tblFInvID and headerid = @tblGrpID)                    
      BEGIN                                                                                                     
      --print '2'                                                                   
       update @tempResult set convvalue =(Select top 1 result from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID)                                                                                                     



  
     
     
    
      
      
      
      
        
          
            
              
                
                  
                    
                     
       ,convReferencerange = (Select top 1 referencerange from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID  and referencerange <> '-')                                                                               



  
    
    
    
      
      
      
      
        
          
            
              
                
                                           
       ,ConvuomCOde = (Select top 1 units from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID),                                                                    
          convvalue01 =(Select top 1 result from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID),                                                                    
         convreferencerange01 = (Select top 1 referencerange from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID  and referencerange <> '-'),                        
         convuomcode01 = (Select top 1 units from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID)                             
                                                                                                                                 
       where investigationid = @tblFInvID and headerid = @tblGrpID                                                                                                    
      END                                                                                                             
  END                                                  
                                                                                                                        
 END                                                                                                                        
                                                                                                                      
Else IF (@Type = 'SideBySide')                                                                                                               
 
 Begin                                                               
                                                                                                               
  IF EXISTS (Select 1 from @tempResult where headerid = @tblGrpID)                                            
    BEGIN                                                                                          
                                                                                                                            
     IF EXISTS (Select 1 from @tempResult where investigationid = @tblFInvID and headerid = @tblGrpID)                       
      BEGIN             
                                 
          --Select count(*) from @tempResult where investigationid = @tblFInvID and grpid = @tblGrpID                                                                                                                    
                                                                             
      DECLARE @UpdateRowID as BIGINT                         
      DECLARE @DeleteRowID as BIGINT                                                                                             
                                                                                 
  SELECT @DeleteRowID = MAX(rowid) from @tempResult where investigationid = @tblSInvID and headerid = @tblGrpID                                                                                                                        
  --select * from @tempResult where investigationid = @tblSInvID and grpid = @tblGrpID                                                                              
  UPDATE @tempResult set convvalue =(Select name from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID)                                                                                                                  




  
     
    
     
       
      
       
       
       
  ,convReferencerange = (Select units from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID)                                                                                                              
  ,ConvuomCOde = (Select result from @tempResultWithReportable where investigationid = @tblSInvID and headerid = @tblGrpID)                                                                                                                          
  where investigationid = @tblFInvID and headerid = @tblGrpID                                   
                            
       delete from @tempResult where rowid = @DeleteRowID                                                               
      END                                            
   END                                                       
 END                                                                                                                        
                                                                  
                                 
  Set @loop = @loop + 1                                                                                           
END                                                                             
                                  
--select tbl.investigationid,tbl.convvalue,tbl.name,tbl.re from @tempResult tbl                                  
                                                            
--select * from @tempResult                                                            
                                                                                
--Select t2.rowid,t2.grpid,t2.groupmedicalremarks,case when Max(t2.rowid) over (partition by t2.grpid )> t2.rowid or grpid is null then null else t2.groupmedicalremarks end as Rm from @tempresult t2                                                      
                                              
                                   
                       
                   
                                                      
                                                        
                                                          
                                                                                                               
--update t1 set groupmedicalremarks = det.rm                                                                                                                  
--select t1.rowid,t1.grpid,t1.groupmedicalremarks,det.rm              
                                                              
--select * from @tempResult                                                              
--return                              
update    T set t.referencerange=''             
from @tempResult T inner join           
InvestigationOrgMapping IOM on T.investigationid=Iom.InvestigationID where Iom.OrgID=@OrgID          
and isnull(iom.OutputInvestigationCode,'') in('NoRefernceRange')         
        
--add by selva for adding line after remarks in report      
update t1 set GroupMedicalRemarks = case when isnull(det.rm,'')!='' then det.rm + '<br>' else det.rm end                                                                                                                          
from @tempResult t1         
inner join                             
(                                                                                                                  
Select t2.rowid,case when Max(t2.rowid) over (partition by t2.grpid )> t2.rowid or grpid is null then null else t2.GroupMedicalRemarks end as Rm from @tempresult t2                Where t2.grpid is not null                                                 



 
    
     
    
      
       
       
      
       
          
            
              
               
                       
) det on t1.rowid = det.rowid                                                                                                        
Where t1.grpid is not null                                                                                 
--and t1.headerid<>0                                                                                 
Update @tempResult SET result ='<0.40' where investigationid in(2011) And result in ('0.00','0','0.0')                                                                        
Update @tempResult SET result ='<0.10' where investigationid in(8671) And result in ('0.00','0','0.0')                                                                                                  
                                                                                                      
--Update t1 set GroupMedicalRemarks='' from @tempResult t1   where  t1.headerid<>0                                                                                                        
  --update @tempResult  set rowid=2 where grpid in (517) and investigationid=0                                      
 --update @tempResult  set rowid=2 where grpid =517 and investigationid=7951                                  
 --update @tempResult  set rowid=2 where grpid=2831 and investigationid=0                                 
 --update @tempResult  set rowid=2 where grpid=2831 and investigationid=4789                                
                                 
UPdate  T                                                          
set result=Case When LEN(RRM.tag)>0 and isabnormal in('A','L','P') then '<B>'+T.result+'</B>'                                                                     
else ISNULL(REPLACE(T.result,'~','<br>'),'') End ,                                                                                   
convvalue=CASE WHEN convvalue ='0' THEN '' When   isabnormal in('A','L','P') then                                                                           
'<B>'+T.convvalue+'</B>' ELSE T.convvalue END                                                                        
From  @tempResult T                                                                         
Left JOIN @TempTable1 T1 on T1.VisitId=T.patientvisiid                                                                                             
LEFT JOIN ReferenceRangeMapping RRM on RRM.Clientid=T1.Clientid                                     
where isabnormal in('A','P','L')                
--UPDATE @tempResult SET AbnormalFlagsymbol='*' WHERE  isabnormal in('A','P','L')                                          
UPDATE @tempResult SET AbnormalFlagsymbol='<B>*</B>' WHERE isabnormal in('A','P','L')                 
UPDATE @tempResult SET ConvAbnormalFlagSymbol='<B>*</B>' WHERE isabnormal in('A','P','L')  and convvalue  <>''                                                                                                    
                                                       
--Update @tempresult set groupmedicalremarks = case when Max(rowid) over (partition by grpid )> rowid then null else groupmedicalremarks end                             
   /* Code changes done by T.Suresh for generate seqnunumber based on the Group details with Rowid start here */                                                                                                
 declare @tmpKeepGrpTogether as table (id smallint identity,startRowNo int,endRowNo int)                                         
 insert @tmpKeepGrpTogether(startRowNo)                                                           
 select                                                                              
 Rowid                       
 From   @tblTempOrdInvExplodedResultOrderbyRowID                                                                 
 group by rowid having COUNT(rowid) >1                                                                                                   
                                                            
--select * from @tempResult                                                                                 
 Update t set endRowNo = (select min(startRowNo)-1 from @tmpKeepGrpTogether tt where tt.startRowNo >t.startRowNo)                                                                                                
 from @tmpKeepGrpTogether t                                                                                                
 update @tmpKeepGrpTogether set endRowNo =(select MAX(rowid) from @tempResult) where endRowNo is null                                                                                                
  Declare @Profilename as table(                                                                    
  packagename varchar(max), RowId int)                      
                                                                                                
 if exists                                                                                                
 (                                                                                                
 select 1 from @tmpKeepGrpTogether                                                     
 )                                                                          
 Begin                                                                                
                    
  delete from @tempResult where rowid in( select MAX(rowid) from @tempResult where patientvisiid=@pVisitID and  InvestigationID<>0                                                                 
group by patientvisiid ,InvestigationID having COUNT(InvestigationID)>1)              
                           
;With A                  
 As                   
 (                  
Select patientvisiid ,InvestigationID ,Row_number() Over (PARTITION BY patientvisiid ,InvestigationID order by Investigationid,rowid )DUp from @tempResult 
where patientvisiid=@pVisitID and  InvestigationID<>0                      
                  
)                  
Delete   from A                    
Where DUp>1                        
                                                     
     Declare @SymbolRow as table(                                                    
  SymbolRowId bigint,                                                    
  InvestigationId int)                                                    
                                                       
 Insert into @SymbolRow                                                       
  SELECT rowid,InvestigationId from @tempResult where result in ('<B>--*</B>','--','--*','<B>--</B>','NA*','NA','<B>NA*</B>','<br><br>')                                           
                                                  
  delete from @tempResult where rowid in(select SymbolRowId from @SymbolRow) and investigationid<>0 and patientvisiid is not null                         
                                    
  delete from @tempResult where  investigationid<>0 and patientvisiid is not null  and result='' or result is  null                                       
  update  @tempResult set result='---',AbnormalFlagsymbol='' where result in ('<B>---</B>')       
Update  @tempResult set referencerange='',convreferencerange='' where  investigationid=7613                                                                            
                                                            
--select * from @tmpKeepGrpTogether                               
            
   Insert into @Profilename     
select packagename,MIN(rowid)                       
from @tempResult t                       
where investigationid = 0                      
group by packagename                       
       --select * from @Profilename                  
       --select * from @tempResult                  
                         
--update t set name = '<B><font size=4>' + p.packagename + '</font></B><br>' + name                      
----select '<B><font size=3>' + p.packagename + '</font></B><br>' + name                    
--from  @tempResult t                       
--inner join @Profilename p on p.RowId = t.rowid                      
--inner join invorggroup iog on iog.AttGroupID = t.PkgId and isnull(iog.IsDisplayProfileName,'N') = 'Y' and iog.OrgID = @OrgID                    
--where investigationid = 0           
      
-- Added By jayaramanan L for Package Name On Off in Report --               
Update @tempResult set patientvisiid=@pVisitID where  investigationid = 0          
update t set name = '<B><font size=4>' + p.packagename + '</font></B><br><br>' + name                      
--select '<B><font size=3>' + p.packagename + '</font></B><br>' + name                    
from  @tempResult t                       
inner join @Profilename p on p.RowId = t.rowid                      
inner join invorggroup iog on iog.AttGroupID = t.PkgId and isnull(iog.IsDisplayProfileName,'N') = 'Y' and iog.OrgID = @OrgID       
inner join VisitClientMapping VCM  On VCM.VisitID=t.patientvisiid and vcm.OrgID=@OrgID  

--inner join ClientwisePakacgeNameOnOff CP On CP.ClientID=VCM.ClientID and CP.OrgID=VCM.OrgID 
      
where investigationid = 0        
                 
           --return                                                              
update @tempResult set notes=(select notes from @tempResult where grpid=2765 and investigationid=9949) where grpid=2765 and investigationid<>0        
update @tempResult set notes='' where grpid=2765  and rowid<>(select MAX(rowid)from @tempResult where grpid=2765 )        
              update t set referencerange =       
               CASE        
               WHEN Printablerange = '' THEN referencerange       
               ELSE       
               ISNULL(Printablerange,referencerange)       
             END        
              from @tempResult t      
                    
Update @tempResult set notes='' where InvestigationID=10437 and Result!='Not Detected'      
      
Update @tempResult set ConvValue='0' where InvestigationID=7054       
      
       
      
 SELECT distinct dense_rank() over (order by tt.id) as KeepGrpTogether,t.*  FROM   @tempResult  t                                                                                   
 inner join @tmpKeepGrpTogether tt on t.rowid between tt.startRowNo and tt.endRowNo                                                                                                                        
 ORDER  BY rowid         
 
                          
 End                                          
 Else                                                                                                
 Begin                                                                
 Insert into @Profilename                                                                                   
select packagename,MIN(rowid)                       
from @tempResult t                       
where investigationid = 0                      
group by packagename                       
                         
Update @tempResult set notes='' where InvestigationID=10437 and Result!='Not Detected'      
Update @tempResult set ConvValue='0' where InvestigationID=7054       
      
       
      
--update t set name = '<B><font size=4>' + p.packagename + '</font></B><br>' + name                      
--from  @tempResult t                       
--inner join @Profilename p on p.RowId = t.rowid                      
--inner join invorggroup iog on iog.AttGroupID = t.PkgId and isnull(iog.IsDisplayProfileName,'N') = 'Y'                    
--where investigationid = 0              
      
-- Starts with Package name display hide bade on Clients Added by Jayaramanan L --      
update t set name = '<B><font size=4>' + p.packagename + '</font></B><br><br>' + name                      
from  @tempResult t                       
inner join @Profilename p on p.RowId = t.rowid                      
inner join invorggroup iog on iog.AttGroupID = t.PkgId and isnull(iog.IsDisplayProfileName,'N') = 'Y'      
inner join VisitClientMapping VCM  On VCM.VisitID=t.patientvisiid and vcm.OrgID=@OrgID 
  
--inner join ClientwisePakacgeNameOnOff CP On CP.ClientID=VCM.ClientID and CP.OrgID=VCM.OrgID                     

where investigationid = 0                      
 -- Ends with Package name display hide bade on Clients Added by Jayaramanan L --              
       
            update t set referencerange =       
               CASE        
               WHEN Printablerange = '' THEN referencerange       
               ELSE       
               ISNULL(Printablerange,referencerange)       
             END        
              from @tempResult t      
        
            SELECT DISTINCT t.rowid AS KeepGrpTogether,        
                            t.*        
            FROM   @tempResult t        
 ORDER  BY rowid                                    
 End                                                                                                                     
 /* Code changes done by T.Suresh for generate seqnunumber based on the Group details with Rowid end here */                                                                                                
END      
      
